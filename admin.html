<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin — AprenderMais</title>
<style>
  :root{--bg:#041022;--card:#071226;--accent:#06b6d4;--muted:#94a3b8}
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,#020416,#061224);color:#e6eef8;padding:18px}
  .wrap{max-width:980px;margin:0 auto}
  header{display:flex;align-items:center;gap:12px}
  .logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#4f46e5);display:flex;align-items:center;justify-content:center}
  .panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);margin-top:16px}
  input,textarea,select,button{font-family:inherit}
  input,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
  .btn{background:var(--accent);border:none;padding:8px 12px;border-radius:10px;color:#021022;cursor:pointer;font-weight:700}
  .muted{color:var(--muted)}
  .hidden{display:none}
  pre{background:#051022;padding:10px;border-radius:8px;overflow:auto}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">AM</div>
      <div>
        <h1>Painel Admin — AprenderMais</h1>
        <div class="muted">Acesso restrito ao administrador</div>
      </div>
      <div style="margin-left:auto">
        <button id="btnSignOut" class="btn hidden">Sair</button>
      </div>
    </header>

    <div id="authBox" class="panel">
      <h3>Login</h3>
      <p class="muted">Faça login com sua conta Google. Somente o email autorizado terá acesso.</p>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="btnGoogle" class="btn">Entrar com Google</button>
        <div id="authStatus" class="muted" style="margin-left:12px"></div>
      </div>
      <div id="authError" style="color:#ff7b7b;margin-top:8px"></div>
    </div>

    <div id="adminPanel" class="panel hidden" aria-live="polite">
      <h3>Admin autorizado</h3>
      <div class="muted">Bem-vindo, <span id="adminName"></span> (<span id="adminEmail"></span>)</div>

      <hr style="margin:12px 0"/>

      <h4>Criar tarefa para bot</h4>
      <div style="display:grid;gap:8px">
        <label>Título</label>
        <input id="taskTitle" placeholder="Ex: gerar relatório semanal" />
        <label>Tipo (ex: http_request, generate_file)</label>
        <select id="taskType">
          <option value="http_request">http_request</option>
          <option value="generate_file">generate_file</option>
        </select>
        <label>Payload JSON (opcional)</label>
        <textarea id="taskPayload" rows="4" placeholder='{"url":"https://example.com","method":"GET"}'></textarea>

        <div style="display:flex;gap:8px">
          <button id="btnCreateTask" class="btn">Criar tarefa</button>
          <button id="btnListTasks" class="btn">Listar fila</button>
        </div>

        <div id="taskMsg" class="muted"></div>
      </div>

      <hr style="margin:12px 0"/>

      <h4>Fila / Logs</h4>
      <div id="queueArea">
        <div id="queueList" class="muted">Nenhuma requisição ainda.</div>
      </div>

      <hr style="margin:12px 0"/>
      <h4>Admin actions</h4>
      <button id="btnPurge" class="btn">Purgar fila (apagar tarefas)</button>
      <div style="margin-top:8px;color:#f6f6c9">Atenção: esta ação remove dados da DB.</div>
    </div>

    <div style="margin-top:14px" class="muted small">Configuração requerida: crie um OAuth Client no Google Cloud e autorize o domínio; adicione regras do Realtime DB conforme necessário.</div>
  </div>

  <!-- Firebase libs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
  // ====== CONFIGURE AQUI seu firebaseConfig público (igual aos outros arquivos) ======
  const firebaseConfig = {
    apiKey: "AIzaSyALpPt-tUWB0Gq-UeJXOJRRkyt0si8s4Nc",
    authDomain: "fir-auth-3521c.firebaseapp.com",
    databaseURL: "https://fir-auth-3521c-default-rtdb.firebaseio.com",
    projectId: "fir-auth-3521c",
    storageBucket: "fir-auth-3521c.firebasestorage.app",
    messagingSenderId: "873308453565",
    appId: "1:873308453565:web:4ff8d9863adb1eae1c95d4",
    measurementId: "G-LWMZJ55W7N"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  // allowed admin email
  const ALLOWED_ADMIN_EMAIL = "gabrielcordeirosilva2010@gmail.com";

  // elements
  const btnGoogle = document.getElementById('btnGoogle');
  const authStatus = document.getElementById('authStatus');
  const authError = document.getElementById('authError');
  const adminPanel = document.getElementById('adminPanel');
  const authBox = document.getElementById('authBox');
  const adminName = document.getElementById('adminName');
  const adminEmail = document.getElementById('adminEmail');
  const btnSignOut = document.getElementById('btnSignOut');

  const taskTitle = document.getElementById('taskTitle');
  const taskType = document.getElementById('taskType');
  const taskPayload = document.getElementById('taskPayload');
  const btnCreateTask = document.getElementById('btnCreateTask');
  const btnListTasks = document.getElementById('btnListTasks');
  const queueList = document.getElementById('queueList');
  const taskMsg = document.getElementById('taskMsg');
  const btnPurge = document.getElementById('btnPurge');

  // auth state
  auth.onAuthStateChanged(user => {
    if (user && !user.isAnonymous) {
      const email = user.email || "";
      if (email.toLowerCase() !== ALLOWED_ADMIN_EMAIL.toLowerCase()) {
        authError.textContent = "Acesso negado: este e-mail não é administrador.";
        auth.signOut();
        return;
      }
      // allowed -> show admin panel
      authBox.classList.add('hidden');
      adminPanel.classList.remove('hidden');
      btnSignOut.classList.remove('hidden');
      adminName.textContent = user.displayName || "(sem nome)";
      adminEmail.textContent = user.email || "";
      authStatus.textContent = "Conectado";
      loadQueue();
    } else {
      // show login box
      authBox.classList.remove('hidden');
      adminPanel.classList.add('hidden');
      btnSignOut.classList.add('hidden');
      authStatus.textContent = "";
    }
  });

  // sign-in with Google popup
  btnGoogle.addEventListener('click', async () => {
    authError.textContent = "";
    authStatus.textContent = "Abrindo popup...";
    const provider = new firebase.auth.GoogleAuthProvider();
    try {
      await auth.signInWithPopup(provider);
      authStatus.textContent = "Autenticado";
    } catch (e) {
      console.error(e);
      authError.textContent = "Erro ao autenticar: " + (e.message || e.code || e);
      authStatus.textContent = "";
    }
  });

  btnSignOut.addEventListener('click', async () => {
    await auth.signOut();
    location.reload();
  });

  // create a task in Realtime DB (queue)
  btnCreateTask.addEventListener('click', async () => {
    const title = (taskTitle.value || "").trim();
    const type = taskType.value;
    let payload = {};
    if (!title) { taskMsg.textContent = "Preencha um título"; return; }
    try {
      if (taskPayload.value.trim()) payload = JSON.parse(taskPayload.value);
    } catch (e) {
      taskMsg.textContent = "Payload JSON inválido";
      return;
    }
    taskMsg.textContent = "Enviando...";
    const task = {
      title,
      type,
      payload,
      status: "queued",
      createdAt: Date.now()
    };
    try {
      await db.ref('adminTasks').push(task);
      taskMsg.textContent = "Tarefa adicionada à fila";
      taskTitle.value = ""; taskPayload.value = "";
      loadQueue();
    } catch (e) {
      console.error(e);
      taskMsg.textContent = "Erro ao criar tarefa";
    }
  });

  // list queue
  btnListTasks.addEventListener('click', loadQueue);

  async function loadQueue(){
    queueList.textContent = "Carregando fila...";
    try {
      const snap = await db.ref('adminTasks').orderByChild('createdAt').limitToLast(100).once('value');
      const arr = [];
      snap.forEach(c => { arr.push({ id: c.key, ...c.val() }); });
      arr.sort((a,b) => (b.createdAt||0) - (a.createdAt||0));
      if (!arr.length) { queueList.textContent = "Fila vazia."; return; }
      // render
      queueList.innerHTML = arr.map(item => {
        return `<div style="padding:8px;border-radius:8px;margin-bottom:6px;background:#021426;border:1px solid rgba(255,255,255,0.02)">
          <strong>${escapeHtml(item.title)}</strong> — <span class="muted">${escapeHtml(item.type)}</span><br/>
          <small class="muted">status: ${escapeHtml(item.status || '')} • ${new Date(item.createdAt).toLocaleString()}</small>
          <pre style="margin-top:6px;color:#cfefff">${escapeHtml(JSON.stringify(item.payload || {}, null, 2))}</pre>
        </div>`;
      }).join('');
    } catch (e) {
      console.error(e);
      queueList.textContent = "Erro ao carregar fila";
    }
  }

  // purge queue (DELETE) — destructive! confirm
  btnPurge.addEventListener('click', async () => {
    if (!confirm('Tem certeza que deseja apagar todas as tarefas da fila? Esta ação é irreversível.')) return;
    try {
      await db.ref('adminTasks').remove();
      toast('Fila apagada');
      loadQueue();
    } catch (e) {
      console.error(e);
      alert('Erro ao apagar fila');
    }
  });

  // helper html escape
  function escapeHtml(s){ if (!s) return ''; return String(s).replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[ch]); }

  // small toast
  function toast(msg){ const el = document.createElement('div'); el.textContent = msg; el.style.cssText='position:fixed;right:18px;bottom:18px;background:var(--accent);padding:10px;border-radius:10px;color:#021022;font-weight:700'; document.body.appendChild(el); setTimeout(()=>el.remove(),2200); }
  </script>
</body>
</html>
