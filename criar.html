<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>AprenderMais ‚Äî Criar Cursos (Avan√ßado)</title>
  <meta name="description" content="Painel de cria√ß√£o de cursos ‚Äî AprenderMais. Crie cursos e adicione m√≥dulos com imagem e link (Firebase).">
  <style>
    /* =========================
       THEME: azul-neon / preto futurista
       ========================= */
    :root{
      --bg:#050814;
      --panel:#071226;
      --card:#0a1724;
      --glass: rgba(255,255,255,0.03);
      --muted: #94a3b8;
      --accent: #4f46e5;
      --accent-2: #06b6d4;
      --success: #16a34a;
      --danger: #ef4444;
      --radius:14px;
      --maxw:1250px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
      background: linear-gradient(180deg, #030416 0%, #071022 100%);
      color:#e6eef8;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding:22px;
    }

    .wrap{max-width:var(--maxw);margin:0 auto}

    header{
      display:flex;
      align-items:center;
      gap:12px;
      padding:12px;
      border-radius:12px;
      background: linear-gradient(90deg, rgba(11,19,40,0.36), rgba(6,18,24,0.36));
      backdrop-filter: blur(6px);
      position:sticky; top:12px; z-index:60;
    }

    .logo{
      width:56px;height:56px;border-radius:12px;
      background:linear-gradient(135deg,var(--accent-2),var(--accent));
      display:flex;align-items:center;justify-content:center;font-weight:900;color:#fff;font-size:18px;
      box-shadow:0 8px 30px rgba(79,70,229,0.12);
    }

    h1{margin:0;font-size:18px}
    .tagline{color:var(--muted);font-size:13px;margin-top:4px}

    nav.top{margin-left:auto;display:flex;gap:8px;align-items:center}
    .btn{background:var(--accent);border:none;color:white;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);font-weight:600}
    .btn.small{padding:6px 8px;font-size:13px;border-radius:8px}
    .link{color:var(--accent-2);text-decoration:none}

    /* layout */
    .grid-layout{display:grid;grid-template-columns:1fr 420px;gap:18px;margin-top:18px}
    @media(max-width:980px){ .grid-layout{grid-template-columns:1fr} }

    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      padding:16px;border-radius:var(--radius);border:1px solid rgba(255,255,255,0.03);
      box-shadow:0 10px 30px rgba(2,6,23,0.6);
    }

    label{display:block;font-size:13px;color:var(--muted);margin-top:10px}
    input,textarea,select{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit}
    textarea{min-height:110px;resize:vertical}

    .row{display:flex;gap:8px}
    .small{font-size:13px;color:var(--muted)}
    .muted{color:var(--muted)}
    .pill{display:inline-block;padding:8px 12px;border-radius:999px;background:rgba(255,255,255,0.02);color:var(--muted);font-size:13px}

    /* course cards list */
    .courses{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:14px;margin-top:16px}
    .course-card{
      background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));
      border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,0.03);
      transition:transform .18s,box-shadow .18s; display:flex;flex-direction:column;gap:10px;
    }
    .course-card:hover{transform:translateY(-6px);box-shadow:0 18px 40px rgba(2,6,23,0.6)}
    .course-top{display:flex;gap:12px;align-items:center}
    .thumb{width:120px;height:76px;border-radius:8px;background:#081226;overflow:hidden;border:1px solid rgba(255,255,255,0.02)}
    .thumb img{width:100%;height:100%;object-fit:cover}

    .course-info{flex:1}
    .course-title{font-weight:800}
    .course-desc{color:var(--muted);font-size:13px;margin-top:6px}

    .course-actions{display:flex;gap:8px;align-items:center;margin-top:auto}

    /* modules area below each course (cards) */
    .modules-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px;margin-top:10px}
    .module-card{
      background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
      border-radius:10px;padding:8px;border:1px solid rgba(255,255,255,0.02);display:flex;flex-direction:column;gap:8px;
    }
    .module-thumb{height:84px;border-radius:8px;overflow:hidden;background:#081226;border:1px solid rgba(255,255,255,0.02)}
    .module-thumb img{width:100%;height:100%;object-fit:cover}
    .module-title{font-weight:700;font-size:13px}
    .module-link{font-size:12px;color:var(--accent-2);word-break:break-all}

    /* modal */
    .modal-back{position:fixed;inset:0;background:linear-gradient(0deg,rgba(0,0,0,0.6),rgba(0,0,0,0.6));display:none;align-items:center;justify-content:center;z-index:200;padding:20px}
    .modal{width:920px;max-width:100%;background:linear-gradient(180deg,#071224,#061622);padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);color:#e6eef8}
    .modal-grid{display:grid;grid-template-columns:1fr 320px;gap:12px}
    @media(max-width:880px){ .modal-grid{grid-template-columns:1fr} }

    /* fancy */
    .glow{box-shadow:0 10px 50px rgba(79,70,229,0.12)}
    .stat{font-size:14px;font-weight:700}
    .note{font-size:13px;color:var(--muted);margin-top:8px}

    /* small helpers */
    .hidden{display:none}
    .danger{background:var(--danger)}

    /* scrolling areas */
    .scroll-y{max-height:420px;overflow:auto;padding-right:6px}
    .muted-link{color:var(--muted);text-decoration:none}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">AM</div>
      <div>
        <h1>AprenderMais ‚Äî Criar Cursos</h1>
        <div class="tagline">Crie cursos e adicione m√≥dulos com imagem e link ‚Äî tudo salvo no Firebase</div>
      </div>

      <nav class="top" aria-label="Navega√ß√£o principal">
        <a class="btn ghost" href="index.html">‚¨Ö Voltar ao In√≠cio</a>
        <a class="btn ghost" href="sobre.html">Mais Sites</a>
        <button id="authBtn" class="btn small">Conectar</button>
      </nav>
    </header>

    <!-- main layout -->
    <div class="grid-layout">
      <!-- left: criar curso e lista -->
      <div>
        <!-- create panel -->
        <section class="panel">
          <h2 id="panelTitle" style="margin:0 0 8px 0">Publicar novo curso</h2>
          <div class="small muted">Preencha os dados e publique. Depois use "‚ûï Adicionar M√≥dulo" no card do curso.</div>

          <label for="nome">Nome do curso</label>
          <input id="nome" placeholder="Ex: Programa√ß√£o Web para iniciantes" />

          <label for="descricao">Descri√ß√£o curta</label>
          <textarea id="descricao" placeholder="Descreva o objetivo do curso em poucas linhas"></textarea>

          <label for="tags">Tags (separadas por v√≠rgula)</label>
          <input id="tags" placeholder="ex: web,frontend,html,css" />

          <label>N√≠vel</label>
          <select id="nivel">
            <option>Iniciante</option>
            <option>Intermedi√°rio</option>
            <option>Avan√ßado</option>
          </select>

          <label>Link (opcional)</label>
          <input id="link" placeholder="Link do curso (opcional) ‚Äî ex: reposit√≥rio, YouTube, Google Drive" />

          <label>Thumbnail do curso (upload ou URL)</label>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="thumbFile" type="file" accept="image/*" />
            <input id="thumbUrl" placeholder="Ou cole uma URL de imagem" style="flex:1" />
          </div>

          <div style="display:flex;gap:8px;margin-top:12px;align-items:center">
            <button id="publicarBtn" class="btn">Publicar curso</button>
            <button id="limparBtn" class="btn ghost">Limpar</button>
            <div style="margin-left:auto" id="pubStatus" class="small muted"></div>
          </div>
        </section>

        <!-- list of courses published by any users (or all) -->
        <section style="margin-top:16px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h3 style="margin:0">Cursos publicados</h3>
            <div class="small muted">Clique em "‚ûï Adicionar M√≥dulo" no curso desejado</div>
          </div>

          <div id="coursesContainer" class="courses" style="margin-top:12px"></div>

          <div id="emptyNote" class="note muted" style="display:none">Nenhum curso publicado ainda.</div>
        </section>
      </div>

      <!-- right: preview + suas a√ß√µes -->
      <aside>
        <section class="panel">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="small muted">Preview do thumbnail</div>
              <div class="muted small">Upload ou cole URL antes de publicar</div>
            </div>
          </div>
          <div style="margin-top:8px" id="thumbPreview" class="thumb"></div>
          <div class="note">Sugerido: 1280√ó720 ‚Äî Formatos: jpg, png</div>
        </section>

        <section class="panel" style="margin-top:12px">
          <h4 style="margin:0">Atalhos</h4>
          <div style="display:flex;flex-direction:column;gap:8px;margin-top:10px">
            <button id="meusCursosBtn" class="btn ghost small">Meus cursos</button>
            <button id="refreshBtn" class="btn small">Atualizar lista</button>
          </div>
          <div class="note" style="margin-top:12px">Autentica√ß√£o: an√¥nima por padr√£o. Para autor rastre√°vel, integre login com Google (opcional).</div>
        </section>
      </aside>
    </div>
  </div>

  <!-- modal: adicionar m√≥dulo -->
  <div id="moduleModal" class="modal-back" aria-hidden="true">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <strong id="moduleModalTitle">Novo M√≥dulo</strong>
          <div class="small muted" id="moduleCourseName">‚Äî</div>
        </div>
        <div style="display:flex;gap:8px">
          <button id="saveModuleBtn" class="btn">Salvar m√≥dulo</button>
          <button id="cancelModuleBtn" class="btn ghost">Cancelar</button>
        </div>
      </div>

      <div class="modal-grid" style="margin-top:12px">
        <div>
          <label>T√≠tulo do m√≥dulo</label>
          <input id="modTitle" placeholder="Ex: Aula 1 ‚Äî Introdu√ß√£o" />

          <label>Descri√ß√£o / Conte√∫do</label>
          <textarea id="modText" placeholder="Descri√ß√£o ou texto do m√≥dulo"></textarea>

          <label>Link opcional (YouTube, Drive, Google Docs...)</label>
          <input id="modLink" placeholder="https://..." />

          <label style="margin-top:8px">Upload de arquivo (txt/pdf/mp4/zip etc.)</label>
          <input id="modFile" type="file" />
        </div>

        <div>
          <label>Imagem do m√≥dulo (upload ou URL)</label>
          <input id="modImageFile" type="file" accept="image/*" />
          <input id="modImageUrl" placeholder="Ou cole URL da imagem" style="margin-top:8px" />
          <div style="margin-top:10px" id="modImagePreview" class="thumb"></div>

          <div class="note" style="margin-top:10px">As imagens ser√£o enviadas para <code>/modulos-imagens/</code> no Firebase Storage.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase compat libraries -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <script>
  /**************************************************************************
   * criar.html ‚Äî AprenderMais (Avan√ßado, tema azul-neon)
   * Regras:
   *  - Apenas cria√ß√£o (sem editar/excluir)
   *  - Bot√£o "‚ûï Adicionar M√≥dulo" por curso (abre modal)
   *  - M√≥dulos salvos em /cursos/{cursoId}/modulos/
   *  - Upload de imagens dos m√≥dulos para /modulos-imagens/
   *  - Autentica√ß√£o an√¥nima autom√°tica
   **************************************************************************/

  // -------------------------- FIREBASE CONFIG --------------------------
  const firebaseConfig = {
    apiKey: "AIzaSyALpPt-tUWB0Gq-UeJXOJRRkyt0si8s4Nc",
    authDomain: "fir-auth-3521c.firebaseapp.com",
    databaseURL: "https://fir-auth-3521c-default-rtdb.firebaseio.com",
    projectId: "fir-auth-3521c",
    storageBucket: "fir-auth-3521c.firebasestorage.app",
    messagingSenderId: "873308453565",
    appId: "1:873308453565:web:4ff8d9863adb1eae1c95d4",
    measurementId: "G-LWMZJ55W7N"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();
  const storage = firebase.storage();

  // -------------------------- UI ELEMENTS --------------------------
  const publicarBtn = document.getElementById('publicarBtn');
  const limparBtn = document.getElementById('limparBtn');
  const nomeEl = document.getElementById('nome');
  const descricaoEl = document.getElementById('descricao');
  const tagsEl = document.getElementById('tags');
  const nivelEl = document.getElementById('nivel');
  const linkEl = document.getElementById('link');
  const thumbFileEl = document.getElementById('thumbFile');
  const thumbUrlEl = document.getElementById('thumbUrl');
  const thumbPreview = document.getElementById('thumbPreview');
  const coursesContainer = document.getElementById('coursesContainer');
  const emptyNote = document.getElementById('emptyNote');
  const pubStatus = document.getElementById('pubStatus');
  const authBtn = document.getElementById('authBtn');
  const refreshBtn = document.getElementById('refreshBtn');
  const meusCursosBtn = document.getElementById('meusCursosBtn');

  // module modal elements
  const moduleModal = document.getElementById('moduleModal');
  const moduleModalTitle = document.getElementById('moduleModalTitle');
  const moduleCourseName = document.getElementById('moduleCourseName');
  const saveModuleBtn = document.getElementById('saveModuleBtn');
  const cancelModuleBtn = document.getElementById('cancelModuleBtn');
  const modTitle = document.getElementById('modTitle');
  const modText = document.getElementById('modText');
  const modLink = document.getElementById('modLink');
  const modFile = document.getElementById('modFile');
  const modImageFile = document.getElementById('modImageFile');
  const modImageUrl = document.getElementById('modImageUrl');
  const modImagePreview = document.getElementById('modImagePreview');

  // other elements
  const meusCursosBtnEl = document.getElementById('meusCursosBtn');

  // -------------------------- STATE --------------------------
  let currentUser = null;
  let currentCourseForModule = null; // { id, nome } when adding module
  let moduleTemp = {}; // holds File objects before upload
  let allCoursesCache = []; // local cache of courses
  let observer = null; // for lazy images

  // -------------------------- UTILITIES --------------------------
  function toast(msg, ms=2200){
    const d = document.createElement('div');
    d.textContent = msg;
    d.style.cssText = "position:fixed;right:18px;bottom:18px;background:#0b1220;padding:12px 16px;border-radius:10px;color:#e6eef8;z-index:9999;border:1px solid rgba(255,255,255,0.03)";
    document.body.appendChild(d);
    setTimeout(()=>d.style.opacity='0', ms);
    setTimeout(()=>d.remove(), ms+300);
  }

  function formatDate(ts){ try { return new Date(ts).toLocaleString(); } catch(e){ return '-'; } }

  function safeText(s){ return (s||'').toString(); }

  // debounce helper
  function debounce(fn, delay=300){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), delay); }; }

  // -------------------------- AUTH (anon) --------------------------
  auth.onAuthStateChanged(u=>{
    currentUser = u;
    if (u){
      authBtn.textContent = 'Conectado';
      loadCourses(); // initial load after auth
    } else {
      authBtn.textContent = 'Conectar';
    }
  });

  authBtn.addEventListener('click', async ()=>{
    if (!auth.currentUser){
      try { await auth.signInAnonymously(); toast('Conectado anonimamente'); }
      catch(e){ console.error(e); toast('Erro ao conectar: '+e.message); }
    } else {
      try { await auth.signOut(); toast('Desconectado'); }
      catch(e){ console.error(e); toast('Erro ao desconectar'); }
    }
  });

  // -------------------------- THUMB PREVIEW --------------------------
  thumbFileEl.addEventListener('change', ()=>{
    const f = thumbFileEl.files[0];
    if (!f){ if (!thumbUrlEl.value) thumbPreview.innerHTML = ''; return; }
    const url = URL.createObjectURL(f);
    thumbPreview.innerHTML = `<img src="${url}" alt="thumbnail">`;
  });

  thumbUrlEl.addEventListener('input', ()=>{
    const v = thumbUrlEl.value.trim();
    if (!v){ if (!thumbFileEl.files.length) thumbPreview.innerHTML = ''; return; }
    thumbPreview.innerHTML = `<img src="${v}" alt="thumbnail">`;
  });

  // -------------------------- PUBLISH COURSE --------------------------
  publicarBtn.addEventListener('click', async ()=>{
    const nome = safeText(nomeEl.value).trim();
    const descricao = safeText(descricaoEl.value).trim();
    const tags = (safeText(tagsEl.value).split(',').map(s=>s.trim()).filter(Boolean));
    const nivel = safeText(nivelEl.value);
    const link = safeText(linkEl.value).trim();

    if (!nome || !descricao){
      alert('Preencha nome e descri√ß√£o do curso.');
      return;
    }
    if (!currentUser){
      alert('Aguarde autentica√ß√£o (clique em Conectar) ou recarregue a p√°gina.');
      return;
    }

    publicarBtn.disabled = true; pubStatus.textContent = 'Salvando...';
    try {
      // handle thumbnail: prefer uploaded file otherwise url
      let thumbnailUrl = thumbUrlEl.value.trim() || null;
      if (thumbFileEl.files.length > 0){
        const f = thumbFileEl.files[0];
        const path = `thumbnails/${currentUser.uid}/${Date.now()}_${f.name}`;
        const ref = storage.ref().child(path);
        await ref.put(f);
        thumbnailUrl = await ref.getDownloadURL();
      }

      const payload = {
        nome, descricao, tags, nivel, link,
        thumbnailUrl: thumbnailUrl || null,
        authorId: currentUser.uid,
        authorName: 'An√¥nimo',
        createdAt: Date.now()
      };

      const newRef = db.ref('cursos').push();
      await newRef.set(payload);
      toast('Curso publicado com sucesso.');
      // clear some fields while leaving others optional
      nomeEl.value=''; descricaoEl.value=''; tagsEl.value=''; nivelEl.value='Iniciante'; linkEl.value=''; thumbFileEl.value=''; thumbUrlEl.value=''; thumbPreview.innerHTML='';
      // refresh
      loadCourses();
    } catch(e){
      console.error(e);
      alert('Erro ao publicar: ' + e.message);
    } finally {
      publicarBtn.disabled = false; pubStatus.textContent = '';
    }
  });

  limparBtn.addEventListener('click', ()=>{
    nomeEl.value=''; descricaoEl.value=''; tagsEl.value=''; nivelEl.value='Iniciante'; linkEl.value=''; thumbFileEl.value=''; thumbUrlEl.value=''; thumbPreview.innerHTML='';
    toast('Formul√°rio limpo.');
  });

  // -------------------------- LOAD COURSES --------------------------
  // listen to /cursos/ changes and render list
  function loadCourses(){
    // show skeleton while loading
    coursesContainer.innerHTML = '';
    emptyNote.style.display = 'none';
    // attach listener
    db.ref('cursos').on('value', snapshot=>{
      const arr = [];
      snapshot.forEach(child=>{
        const c = child.val();
        c._id = child.key;
        c.createdAt = c.createdAt || Date.now();
        c.tags = c.tags || [];
        c.views = c.views || 0;
        c.likes = c.likes || 0;
        arr.push(c);
      });
      // sort newest first
      arr.sort((a,b)=> (b.createdAt || 0) - (a.createdAt || 0));
      allCoursesCache = arr;
      renderCourses(arr);
    }, err=>{
      console.warn('DB read error', err);
      toast('Erro ao carregar cursos ‚Äî verifique a conex√£o.');
    });
  }

  // manual refresh
  refreshBtn.addEventListener('click', ()=> loadCourses());

  meusCursosBtn.addEventListener('click', ()=> {
    if (!currentUser) return toast('Aguarde autentica√ß√£o.');
    // filter and show only courses where authorId == currentUser.uid
    const mine = allCoursesCache.filter(c => c.authorId === currentUser.uid);
    if (!mine.length) toast('Voc√™ ainda n√£o publicou cursos.');
    renderCourses(mine);
  });

  // render function (big)
  function renderCourses(list){
    coursesContainer.innerHTML = '';
    if (!list || !list.length){
      emptyNote.style.display = 'block';
      return;
    }
    emptyNote.style.display = 'none';

    // setup intersection observer for lazy images
    if (observer) observer.disconnect();
    observer = new IntersectionObserver(entries => {
      entries.forEach(entry => {
        if (entry.isIntersecting){
          const img = entry.target;
          if (img.dataset && img.dataset.src){
            img.src = img.dataset.src;
            img.onload = ()=> img.style.opacity = '1';
            img.removeAttribute('data-src');
          }
          observer.unobserve(img);
        }
      });
    }, { rootMargin: '120px', threshold: 0.1 });

    list.forEach(c => {
      const card = document.createElement('div');
      card.className = 'course-card';

      // top area
      const top = document.createElement('div'); top.className = 'course-top';
      const thumb = document.createElement('div'); thumb.className = 'thumb';
      if (c.thumbnailUrl){
        const img = document.createElement('img');
        img.dataset.src = c.thumbnailUrl; img.alt = c.nome || 'thumb'; img.style.opacity='0'; img.style.transition='opacity .3s';
        thumb.appendChild(img);
        observer.observe(img);
      } else {
        thumb.innerHTML = '<div style="padding:14px;color:var(--muted)">Sem imagem</div>';
      }

      const info = document.createElement('div'); info.className = 'course-info';
      info.innerHTML = `<div class="course-title">${escapeHtml(c.nome)}</div>
                        <div class="course-desc">${escapeHtml(truncate(c.descricao, 160))}</div>
                        <div style="margin-top:8px"><span class="pill">${c.nivel || '‚Äî'}</span> <span class="pill" style="margin-left:6px">${(c.tags||[]).slice(0,3).join(', ')}</span></div>`;

      top.appendChild(thumb);
      top.appendChild(info);

      // actions row
      const actions = document.createElement('div'); actions.className = 'course-actions';
      const addModuleBtn = document.createElement('button'); addModuleBtn.className = 'btn small'; addModuleBtn.textContent = '‚ûï Adicionar M√≥dulo';
      addModuleBtn.onclick = ()=> openAddModuleModal(c);

      // view course link if available
      const viewBtn = document.createElement('a'); viewBtn.className='btn small ghost'; viewBtn.textContent='Ver link'; viewBtn.href = c.link || '#';
      viewBtn.target = '_blank'; if (!c.link) viewBtn.style.display = 'none';

      // stats
      const stats = document.createElement('div'); stats.style.marginLeft='auto'; stats.style.fontSize='13px'; stats.style.color='var(--muted)';
      stats.textContent = `üëÄ ${c.views||0} ‚Ä¢ ‚ù§Ô∏è ${c.likes||0} ‚Ä¢ ${formatDate(c.createdAt)}`;

      actions.appendChild(addModuleBtn);
      actions.appendChild(viewBtn);
      actions.appendChild(stats);

      // modules area (below)
      const modulesContainer = document.createElement('div'); modulesContainer.className = 'modules-grid';
      modulesContainer.id = `modules_${c._id}`;

      // append
      card.appendChild(top);
      card.appendChild(actions);
      card.appendChild(modulesContainer);

      coursesContainer.appendChild(card);

      // load modules for this course (non-editable listing)
      loadModulesForCourse(c._id, modulesContainer);
    });
  }

  // -------------------------- MODULES: create & list --------------------------
  // load modules for a course and render them into containerEl
  function loadModulesForCourse(courseId, containerEl){
    containerEl.innerHTML = '<div class="muted small">Carregando m√≥dulos...</div>';
    db.ref(`cursos/${courseId}/modulos`).orderByChild('createdAt').once('value')
      .then(snap=>{
        const mods = [];
        snap.forEach(child => { const m = child.val(); m._id = child.key; mods.push(m); });
        mods.sort((a,b)=> (a.createdAt||0) - (b.createdAt||0));
        containerEl.innerHTML = '';
        if (!mods.length){
          containerEl.innerHTML = '<div class="muted small">Nenhum m√≥dulo ainda</div>';
          return;
        }
        mods.forEach(m=>{
          const mc = document.createElement('div'); mc.className='module-card';
          mc.innerHTML = `<div style="display:flex;gap:8px;align-items:center">
                            <div class="module-thumb">${m.imageUrl ? `<img src="${m.imageUrl}" alt="mod">` : '<div style="padding:10px;color:var(--muted)">Sem imagem</div>'}</div>
                            <div style="flex:1">
                              <div class="module-title">${escapeHtml(m.titulo || 'Sem t√≠tulo')}</div>
                              <div class="muted small">${truncate(m.texto || '', 140)}</div>
                              ${m.link ? `<div class="module-link"><a class="muted-link" href="${m.link}" target="_blank">${m.link}</a></div>` : ''}
                            </div>
                          </div>`;
          containerEl.appendChild(mc);
        });
      })
      .catch(e=>{
        console.warn('Erro modules:', e);
        containerEl.innerHTML = '<div class="muted small">Erro ao carregar m√≥dulos</div>';
      });
  }

  // open modal to add module to course
  function openAddModuleModal(course){
    currentCourseForModule = { id: course._id, nome: course.nome };
    moduleModal.style.display = 'flex';
    moduleModalTitle.textContent = 'Novo m√≥dulo';
    moduleCourseName.textContent = `${course.nome}`;
    // clear fields
    modTitle.value=''; modText.value=''; modLink.value=''; modFile.value=''; modImageFile.value=''; modImageUrl.value=''; modImagePreview.innerHTML='';
    moduleTemp = {};
    // focus
    setTimeout(()=>modTitle.focus(), 240);
  }

  // cancel module
  cancelModuleBtn.addEventListener('click', ()=> {
    moduleModal.style.display = 'none';
    currentCourseForModule = null;
    moduleTemp = {};
  });

  // preview module image
  modImageFile.addEventListener('change', ()=>{
    const f = modImageFile.files[0];
    if (!f){ if (!modImageUrl.value) modImagePreview.innerHTML = ''; return; }
    moduleTemp.image = f;
    const u = URL.createObjectURL(f);
    modImagePreview.innerHTML = `<img src="${u}" alt="preview">`;
  });
  modImageUrl.addEventListener('input', ()=>{
    const v = modImageUrl.value.trim();
    if (!v){ if (!moduleTemp.image) modImagePreview.innerHTML = ''; return; }
    modImagePreview.innerHTML = `<img src="${v}" alt="preview">`;
  });

  // save module handler
  saveModuleBtn.addEventListener('click', async ()=>{
    if (!currentCourseForModule) return alert('Nenhum curso selecionado para adicionar m√≥dulo.');
    const titulo = safeText(modTitle.value).trim();
    const texto = safeText(modText.value).trim();
    const link = safeText(modLink.value).trim();

    if (!titulo && !texto && !moduleTemp.textFile) { alert('Informe t√≠tulo, texto ou fa√ßa upload de arquivo.'); return; }

    saveModuleBtn.disabled = true; saveModuleBtn.textContent = 'Salvando...';

    try {
      const payload = { titulo, texto, link, createdAt: Date.now() };

      // upload image if provided
      if (moduleTemp.image){
        const f = moduleTemp.image;
        const path = `modulos-imagens/${currentUser.uid}/${currentCourseForModule.id}/${Date.now()}_${f.name}`;
        const ref = storage.ref().child(path);
        await ref.put(f);
        payload.imageUrl = await ref.getDownloadURL();
      } else if (modImageUrl.value.trim()){
        payload.imageUrl = modImageUrl.value.trim();
      }

      // upload file if provided
      const fileInput = document.getElementById('modFile');
      if (fileInput.files.length){
        const f2 = fileInput.files[0];
        const path = `modulos-files/${currentUser.uid}/${currentCourseForModule.id}/${Date.now()}_${f2.name}`;
        const ref2 = storage.ref().child(path);
        await ref2.put(f2);
        payload.fileUrl = await ref2.getDownloadURL();
      }

      // push to database under /cursos/{cursoId}/modulos
      const pushRef = db.ref(`cursos/${currentCourseForModule.id}/modulos`).push();
      await pushRef.set(payload);

      toast('M√≥dulo adicionado com sucesso.');
      // close modal and refresh modules area for that course (we reload with loadModulesForCourse)
      moduleModal.style.display = 'none';
      // refresh the modules area in the DOM: find container and reload
      const container = document.getElementById(`modules_${currentCourseForModule.id}`);
      if (container) loadModulesForCourse(currentCourseForModule.id, container);
      moduleTemp = {};
    } catch(e){
      console.error(e);
      alert('Erro ao salvar m√≥dulo: ' + e.message);
    } finally {
      saveModuleBtn.disabled = false; saveModuleBtn.textContent = 'Salvar m√≥dulo';
    }
  });

  // -------------------------- SMALL HELPERS --------------------------
  function truncate(s, n=140){ if (!s) return ''; return s.length > n ? s.slice(0,n-1) + '‚Ä¶' : s; }
  function escapeHtml(str){
    if (!str) return '';
    return str.replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; });
  }

  // -------------------------- INITIALIZE --------------------------
  (function init(){
    // sign in anonymous automatically for convenience (no need user action)
    if (!auth.currentUser) auth.signInAnonymously().catch(()=>{});
    // initial load (will be triggered after auth state)
    // keep a safety: if DB is slow, we still try to load
    setTimeout(()=> {
      if (!allCoursesCache.length) loadCourses();
    }, 800);
  })();

  // expose debug hooks (optional)
  window._apm = {
    loadCourses, allCoursesCache
  };

  </script>
</body>
</html>
