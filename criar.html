<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>AprenderMais — Criar Cursos (Login + Google)</title>
<meta name="description" content="Painel AprenderMais: login (Email/Senha + Google) integrado, criar cursos e adicionar módulos."/>
<style>
/* --- Theme & layout (compacto) --- */
:root{--bg:#050814;--muted:#94a3b8;--accent:#4f46e5;--accent2:#06b6d4;--card:#071226;--radius:12px;--danger:#ef4444;--success:#16a34a}
*{box-sizing:border-box}body{margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,#030416,#071022);color:#e6eef8;padding:18px}
.wrap{max-width:1200px;margin:0 auto}header{display:flex;gap:12px;align-items:center;padding:12px;border-radius:12px;background:linear-gradient(90deg, rgba(11,19,40,0.36), rgba(6,18,24,0.36));backdrop-filter:blur(6px)}
.logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent2),var(--accent));display:flex;align-items:center;justify-content:center;font-weight:900}
h1{margin:0}.tag{color:var(--muted);font-size:13px}nav{margin-left:auto;display:flex;gap:8px;align-items:center}
.btn{background:var(--accent);color:white;border:none;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700}.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
.grid{display:grid;grid-template-columns:1fr 380px;gap:18px;margin-top:18px}@media(max-width:980px){.grid{grid-template-columns:1fr}}
.panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
label{display:block;color:var(--muted);margin-top:10px}input,textarea,select{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit}
textarea{min-height:100px;resize:vertical}.thumb{height:140px;border-radius:10px;background:#081226;border:1px solid rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:center;overflow:hidden}
.progress{height:8px;background:rgba(255,255,255,0.06);border-radius:999px;overflow:hidden;margin-top:8px}.progress>i{display:block;height:100%;background:linear-gradient(90deg,var(--accent2),var(--accent));width:0%}
.muted{color:var(--muted)}.small{font-size:13px}.courses{margin-top:14px;display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:12px}.card{background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
.modules{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}.mcard{width:160px;background:rgba(255,255,255,0.01);padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.02)}
.hidden{display:none}.status{font-size:13px;color:var(--muted);margin-left:8px}

/* AUTH overlay */
.auth-back{position:fixed;inset:0;background:linear-gradient(180deg, rgba(0,0,0,0.68), rgba(0,0,0,0.68));display:flex;align-items:center;justify-content:center;z-index:999;padding:18px}
.auth-card{width:920px;max-width:100%;background:linear-gradient(180deg,#071224,#061622);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);color:#e6eef8}
.auth-grid{display:grid;grid-template-columns:1fr 320px;gap:12px}.social-btn{display:flex;gap:8px;align-items:center;background:#0b1220;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);cursor:pointer}
.error{color:var(--danger);font-weight:700;margin-top:8px} .success{color:var(--success);font-weight:700;margin-top:8px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">AM</div>
    <div>
      <h1>AprenderMais — Criar Cursos</h1>
      <div class="tag">Login (Email + Google). Publique cursos após entrar.</div>
    </div>
    <nav>
      <a class="btn ghost" href="index.html">⬅ Voltar ao Início</a>
      <a class="btn ghost" href="sobre.html">Mais Sites</a>
      <button id="btnSignOut" class="btn ghost hidden">Sair</button>
      <div id="userInfo" class="status"></div>
    </nav>
  </header>

  <div class="grid" id="mainGrid">
    <main>
      <section class="panel" id="createPanel">
        <h3>Publicar novo curso</h3>
        <div class="muted small">Você precisa estar logado (Email ou Google) para publicar.</div>

        <label>Nome</label><input id="nome" placeholder="Ex: Curso de JavaScript" />
        <label>Descrição</label><textarea id="descricao" placeholder="Descrição do curso"></textarea>
        <label>Tags (vírgula)</label><input id="tags" placeholder="web,frontend,js" />
        <label>Nível</label><select id="nivel"><option>Iniciante</option><option>Intermediário</option><option>Avançado</option></select>
        <label>Link opcional</label><input id="link" placeholder="https://..." />

        <label>Thumbnail (upload ou URL)</label>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="thumbFile" type="file" accept="image/*" />
          <input id="thumbUrl" placeholder="Ou cole URL" style="flex:1" />
        </div>
        <div id="thumbPreview" class="thumb"></div>
        <div id="thumbProgress" class="progress hidden"><i></i></div>

        <div style="display:flex;gap:8px;margin-top:12px;align-items:center">
          <button id="btnPublicar" class="btn">Publicar curso</button>
          <button id="btnLimpar" class="btn ghost">Limpar</button>
          <div id="pubMsg" class="status"></div>
        </div>
      </section>

      <section style="margin-top:14px">
        <h3>Cursos</h3>
        <div id="courses" class="courses"></div>
        <div id="none" class="muted small hidden">Nenhum curso publicado ainda.</div>
      </section>
    </main>

    <aside>
      <section class="panel">
        <h4>Preview</h4>
        <div class="small muted">Thumbnail selecionado</div>
        <div id="sideThumb" class="thumb" style="margin-top:8px"></div>
        <div class="small muted" style="margin-top:8px">Imagens serão redimensionadas antes do upload (opção otimizada).</div>
      </section>

      <section class="panel" style="margin-top:12px">
        <h4>Atalhos</h4>
        <div style="display:flex;flex-direction:column;gap:8px;margin-top:10px">
          <button id="btnMeus" class="btn ghost small">Meus cursos</button>
          <button id="btnRefresh" class="btn small">Atualizar</button>
        </div>
        <div class="note" style="margin-top:12px">Login por Email/Senha e Google. Autenticação anônima é mantida apenas para leitura.</div>
      </section>
    </aside>
  </div>
</div>

<!-- modal: adicionar módulo (mantido) -->
<div id="moduleModal" class="hidden" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:100;padding:14px">
  <div style="width:920px;max-width:100%;background:linear-gradient(180deg,#071224,#061622);padding:16px;border-radius:10px;color:#e6eef8">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <strong id="moduleModalTitle">Adicionar Módulo</strong><div id="moduleCourseName" class="muted small"></div>
      </div>
      <div style="display:flex;gap:8px">
        <button id="modalSave" class="btn">Salvar</button>
        <button id="modalCancel" class="btn ghost">Cancelar</button>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 320px;gap:12px;margin-top:12px">
      <div>
        <label>Título</label><input id="modTitulo" />
        <label>Descrição</label><textarea id="modTexto"></textarea>
        <label>Link opcional</label><input id="modLink" />
        <label>Arquivo opcional</label><input id="modFile" type="file" />
      </div>
      <div>
        <label>Imagem do módulo (upload ou URL)</label><input id="modImageFile" type="file" accept="image/*" /><input id="modImageUrl" placeholder="Ou cole URL" style="margin-top:8px" />
        <div id="modPreview" class="thumb" style="margin-top:8px"></div>
        <div id="modProgress" class="progress hidden"><i></i></div>
      </div>
    </div>
  </div>
</div>

<!-- auth overlay (login + register + google) -->
<div id="authOverlay" class="auth-back" style="display:flex;">
  <div class="auth-card">
    <div style="display:flex;justify-content:space-between;align-items:start">
      <div>
        <h2 style="margin:0">Entrar no AprenderMais</h2>
        <div class="muted small">Registre-se para publicar cursos. Ou entre com Google.</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <div id="authStatusMsg" class="muted small"></div>
      </div>
    </div>

    <div class="auth-grid" style="margin-top:12px">
      <div>
        <label>Email</label><input id="authEmail" placeholder="seu@exemplo.com" />
        <label>Senha</label><input id="authPass" type="password" placeholder="Senha (min 6 caracteres)" />
        <div style="display:flex;gap:8px;margin-top:10px">
          <button id="btnLogin" class="btn">Entrar</button>
          <button id="btnRegister" class="btn ghost">Criar conta</button>
        </div>
        <div id="authError" class="error hidden"></div>
        <div id="authSuccess" class="success hidden"></div>
        <div style="margin-top:10px" class="muted small">ou entre com:</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <div id="btnGoogle" class="social-btn"><img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='18' height='18'><path fill='%23EA4335' d='M9 4.48c1.69 0 2.84.73 3.5 1.34l2.59-2.5C13.92 1.65 11.68.5 9 .5 5.48.5 2.53 2.6.9 5.7l2.78 2.16C4.1 6.1 6.32 4.48 9 4.48z'/></svg>" style="width:18px;height:18px"/> Entrar com Google</div>
        </div>
      </div>
      <aside style="border-left:1px solid rgba(255,255,255,0.03);padding-left:12px">
        <h4 style="margin-top:0">Por que se registrar?</h4>
        <ul class="muted small">
          <li>Publicar cursos e associar autoria</li>
          <li>Gerenciar módulos e uploads</li>
          <li>Atribuir créditos e reputação</li>
        </ul>
        <div style="margin-top:12px" class="muted small">Autenticação segura via Firebase Authentication.</div>
      </aside>
    </div>
  </div>
</div>

<!-- Firebase libs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<script>
/**************************************************************************
 * criar.html — Login integrado (Email + Google) + painel de criação
 * IMPORTANT: Do NOT put hash_config or other sensitive keys in this file.
 * If you want to use an OAuth Web Client ID (Google Cloud) for extra features,
 * create it in Google Cloud Console and add your domain (gbzstudio.github.io).
 *
 * If you have the CLIENT_ID you can optionally use it for Google One-Tap or
 * to configure additional Google APIs, but Firebase signInWithPopup works
 * without placing the client ID in the front-end.
 **************************************************************************/

/* ---------------- FIREBASE CONFIG (public) ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyALpPt-tUWB0Gq-UeJXOJRRkyt0si8s4Nc",
  authDomain: "fir-auth-3521c.firebaseapp.com",
  databaseURL: "https://fir-auth-3521c-default-rtdb.firebaseio.com",
  projectId: "fir-auth-3521c",
  storageBucket: "fir-auth-3521c.firebasestorage.app",
  messagingSenderId: "873308453565",
  appId: "1:873308453565:web:4ff8d9863adb1eae1c95d4",
  measurementId: "G-LWMZJ55W7N"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth(), db = firebase.database(), storage = firebase.storage();

/* ---------------- ELEMENTS ---------------- */
const authOverlay = document.getElementById('authOverlay');
const authEmail = document.getElementById('authEmail'), authPass = document.getElementById('authPass');
const btnLogin = document.getElementById('btnLogin'), btnRegister = document.getElementById('btnRegister');
const btnGoogle = document.getElementById('btnGoogle'), authError = document.getElementById('authError'), authSuccess = document.getElementById('authSuccess');
const authStatusMsg = document.getElementById('authStatusMsg');
const btnSignOut = document.getElementById('btnSignOut'), userInfo = document.getElementById('userInfo');

const btnPublicar = document.getElementById('btnPublicar'), btnLimpar = document.getElementById('btnLimpar');
const nomeEl = document.getElementById('nome'), descricaoEl = document.getElementById('descricao'), tagsEl = document.getElementById('tags'), nivelEl = document.getElementById('nivel'), linkEl = document.getElementById('link');
const thumbFile = document.getElementById('thumbFile'), thumbUrl = document.getElementById('thumbUrl'), thumbPreview = document.getElementById('thumbPreview'), sideThumb = document.getElementById('sideThumb');
const thumbProgress = document.getElementById('thumbProgress'), thumbProgressBar = thumbProgress.querySelector('i');
const coursesEl = document.getElementById('courses'), noneEl = document.getElementById('none'), pubMsg = document.getElementById('pubMsg');
const btnMeus = document.getElementById('btnMeus'), btnRefresh = document.getElementById('btnRefresh');

const moduleModal = document.getElementById('moduleModal'), moduleModalTitle = document.getElementById('moduleModalTitle'), moduleCourseName = document.getElementById('moduleCourseName');
const modalSave = document.getElementById('modalSave'), modalCancel = document.getElementById('modalCancel');
const modTitulo = document.getElementById('modTitulo'), modTexto = document.getElementById('modTexto'), modLink = document.getElementById('modLink'), modFile = document.getElementById('modFile');
const modImageFile = document.getElementById('modImageFile'), modImageUrl = document.getElementById('modImageUrl'), modPreview = document.getElementById('modPreview'), modProgress = document.getElementById('modProgress'), modProgressBar = modProgress.querySelector('i');

let currentUser = null;
let coursesCache = [];
let currentCourseForModule = null;
let tempModuleImage = null;

/* ---------------- HELPERS ---------------- */
function toast(msg, t=2200){ const d=document.createElement('div'); d.textContent=msg; d.style.cssText="position:fixed;right:18px;bottom:18px;background:#061024;color:#e6eef8;padding:12px 16px;border-radius:10px;z-index:9999;border:1px solid rgba(255,255,255,0.03)"; document.body.appendChild(d); setTimeout(()=>d.style.opacity='0', t); setTimeout(()=>d.remove(), t+300); }
function fmt(t){ try{return new Date(t).toLocaleString(); } catch(e){ return '-'; } }
function truncate(s,n=120){ if(!s) return ''; return s.length>n? s.slice(0,n-1)+'…': s; }
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[ch]); }

/* debounce */
function debounce(fn,ms=300){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); } }

/* image resize helper */
async function resizeImageFile(file, maxWidth=1280, maxHeight=720, quality=0.82){
  return new Promise((res, rej)=>{
    const img = new Image();
    const url = URL.createObjectURL(file);
    img.onload = () => {
      let w = img.naturalWidth, h = img.naturalHeight;
      const ratio = Math.min(1, maxWidth/w, maxHeight/h);
      w = Math.round(w*ratio); h = Math.round(h*ratio);
      const canvas = document.createElement('canvas'); canvas.width=w; canvas.height=h;
      const ctx = canvas.getContext('2d'); ctx.drawImage(img,0,0,w,h);
      canvas.toBlob(blob => { URL.revokeObjectURL(url); if(!blob) return rej(new Error('Falha no resize')); res(blob); }, 'image/jpeg', quality);
    };
    img.onerror = (e)=>{ URL.revokeObjectURL(url); rej(e); };
    img.src = url;
  });
}

/* upload with progress */
function uploadWithProgress(storagePath, fileOrBlob, onProgress){
  const ref = storage.ref().child(storagePath);
  const task = ref.put(fileOrBlob);
  return new Promise((resolve,reject)=>{
    task.on('state_changed', snap=>{
      const pct = Math.round((snap.bytesTransferred/snap.totalBytes)*100);
      if(onProgress) onProgress(pct);
    }, err=>reject(err), async ()=>{ try{ const url = await task.snapshot.ref.getDownloadURL(); resolve(url);} catch(e){ reject(e); }});
  });
}

/* ---------------- AUTH (email/password + Google) ---------------- */
/* Optional: If you want to use your OAuth 2.0 Web Client ID for Google One-Tap or other
   Google APIs, create it in Google Cloud Console and add your domain (gbzstudio.github.io).
   You do NOT need to paste that client ID here for Firebase signInWithPopup to work.
   If you do have a CLIENT_ID and plan to use One-Tap, put it in a safe place and use it
   only for that extra feature. */

auth.onAuthStateChanged(u=>{
  currentUser = u;
  if(u && !u.isAnonymous){
    hideAuthOverlay();
    onUserReady(u);
  } else {
    showAuthOverlay();
    if(!u) auth.signInAnonymously().catch(()=>{});
  }
  // update UI sign-out
  if(u && !u.isAnonymous){ btnSignOut.classList.remove('hidden'); userInfo.textContent = (u.displayName || u.email || ('uid:' + u.uid)); }
  else { btnSignOut.classList.add('hidden'); userInfo.textContent = ''; }
});

function showAuthOverlay(){ authOverlay.style.display='flex'; }
function hideAuthOverlay(){ authOverlay.style.display='none'; authError.classList.add('hidden'); authSuccess.classList.add('hidden'); authStatusMsg.textContent=''; }

// Email/password login
btnLogin.addEventListener('click', async ()=>{
  const email = (authEmail.value||'').trim(), pass = (authPass.value||'').trim();
  authError.classList.add('hidden'); authSuccess.classList.add('hidden'); authStatusMsg.textContent='Entrando...';
  if(!email || !pass){ authError.textContent='Preencha email e senha.'; authError.classList.remove('hidden'); authStatusMsg.textContent=''; return; }
  try{ await auth.signInWithEmailAndPassword(email, pass); authSuccess.textContent='Conectado!'; authSuccess.classList.remove('hidden'); authStatusMsg.textContent=''; }
  catch(e){ console.error(e); authError.textContent='Erro: ' + (e.message || e.code); authError.classList.remove('hidden'); authStatusMsg.textContent=''; }
});

// Register
btnRegister.addEventListener('click', async ()=>{
  const email = (authEmail.value||'').trim(), pass = (authPass.value||'').trim();
  authError.classList.add('hidden'); authSuccess.classList.add('hidden'); authStatusMsg.textContent='Criando conta...';
  if(!email || !pass || pass.length<6){ authError.textContent='Email inválido ou senha com < 6 chars.'; authError.classList.remove('hidden'); authStatusMsg.textContent=''; return; }
  try{
    const userCred = await auth.createUserWithEmailAndPassword(email, pass);
    await userCred.user.updateProfile({ displayName: email.split('@')[0] }).catch(()=>{});
    authSuccess.textContent = 'Conta criada — bem-vindo!';
    authSuccess.classList.remove('hidden');
    authStatusMsg.textContent='';
  }catch(e){ console.error(e); authError.textContent='Erro ao criar conta: ' + (e.message || e.code); authError.classList.remove('hidden'); authStatusMsg.textContent=''; }
});

// Google Sign-In (popup)
// Note: you do NOT need to publish a client ID into this file; ensure your Google Cloud OAuth 2.0 Client has this
// origin (gbzstudio.github.io) authorized. Firebase will use the configuration of your Firebase project.
btnGoogle.addEventListener('click', async ()=>{
  authError.classList.add('hidden'); authSuccess.classList.add('hidden'); authStatusMsg.textContent='Conectando com Google...';
  const provider = new firebase.auth.GoogleAuthProvider();
  provider.addScope('profile'); provider.addScope('email');
  // Optional: provider.setCustomParameters({ 'prompt': 'select_account' });
  try{
    await auth.signInWithPopup(provider);
    authSuccess.textContent = 'Conectado com Google!';
    authSuccess.classList.remove('hidden');
    authStatusMsg.textContent = '';
  }catch(e){ console.error(e); authError.textContent = 'Erro Google: ' + (e.message || e.code); authError.classList.remove('hidden'); authStatusMsg.textContent=''; }
});

// Sign out
btnSignOut.addEventListener('click', async ()=>{ try{ await auth.signOut(); toast('Desconectado'); showAuthOverlay(); }catch(e){ toast('Erro ao sair'); } });

/* ---------------- ON USER READY ---------------- */
function onUserReady(user){
  // enable features that require an identified user (not anonymous)
  loadCourses();
}

/* ---------------- PUBLISH COURSE ---------------- */
btnPublicar.addEventListener('click', async ()=>{
  const nome = (nomeEl.value||'').trim(), descricao = (descricaoEl.value||'').trim();
  const tags = (tagsEl.value||'').split(',').map(s=>s.trim()).filter(Boolean), nivel = (nivelEl.value||'').trim(), link = (linkEl.value||'').trim();
  const u = auth.currentUser;
  if(!u || u.isAnonymous){ alert('Você precisa estar logado com conta (email/google) para publicar.'); return; }
  if(!nome || !descricao){ alert('Preencha nome e descrição'); return; }
  btnPublicar.disabled = true; pubMsg.textContent='Processando...';
  try{
    let thumbnailUrl = thumbUrl.value.trim() || null;
    if(thumbFile.files.length > 0){
      const f = thumbFile.files[0];
      if(!f.type.startsWith('image/')) throw new Error('Thumbnail precisa ser imagem');
      if(f.size > 20 * 1024 * 1024) throw new Error('Thumbnail muito grande (max 20MB)');
      const resized = await resizeImageFile(f, 1280, 720, 0.82);
      thumbProgress.classList.remove('hidden'); thumbProgressBar.style.width='0%';
      const path = `thumbnails/${u.uid}/${Date.now()}_${f.name.replace(/\s/g,'_')}`;
      thumbnailUrl = await uploadWithProgress(path, resized, pct => { thumbProgressBar.style.width = pct + '%'; });
      thumbProgress.classList.add('hidden');
    }
    const payload = { nome, descricao, tags, nivel, link, thumbnailUrl: thumbnailUrl || null, authorId: u.uid, authorName: u.displayName || u.email || ('uid:'+u.uid), createdAt: Date.now() };
    await db.ref('cursos').push(payload);
    toast('Curso publicado com sucesso.');
    // clear
    nomeEl.value=''; descricaoEl.value=''; tagsEl.value=''; nivelEl.value='Iniciante'; linkEl.value=''; thumbFile.value=''; thumbUrl.value=''; thumbPreview.innerHTML=''; sideThumb.innerHTML='';
  }catch(e){ console.error(e); alert('Erro ao publicar: ' + (e.message || e)); }
  finally{ btnPublicar.disabled=false; pubMsg.textContent=''; }
});

btnLimpar.addEventListener('click', ()=>{ nomeEl.value=''; descricaoEl.value=''; tagsEl.value=''; nivelEl.value='Iniciante'; linkEl.value=''; thumbFile.value=''; thumbUrl.value=''; thumbPreview.innerHTML=''; sideThumb.innerHTML=''; toast('Campos limpos'); });

thumbFile.addEventListener('change', ()=>{ const f = thumbFile.files[0]; if(!f){ if(!thumbUrl.value) thumbPreview.innerHTML=''; return; } const url = URL.createObjectURL(f); thumbPreview.innerHTML = `<img src="${url}" style="width:100%;height:100%;object-fit:cover">`; sideThumb.innerHTML = thumbPreview.innerHTML; });
thumbUrl.addEventListener('input', ()=>{ const v = (thumbUrl.value||'').trim(); if(!v){ if(!thumbFile.files.length){ thumbPreview.innerHTML=''; sideThumb.innerHTML=''; } return; } thumbPreview.innerHTML = `<img src="${v}" style="width:100%;height:100%;object-fit:cover">`; sideThumb.innerHTML = thumbPreview.innerHTML; });

/* ---------------- COURSES LISTEN & RENDER ---------------- */
function loadCourses(){
  coursesEl.innerHTML = ''; noneEl.classList.add('hidden');
  db.ref('cursos').on('value', snap => {
    const arr=[]; snap.forEach(child=>{ const c=child.val(); c._id = child.key; c.tags = c.tags || []; c.createdAt = c.createdAt || Date.now(); arr.push(c); });
    arr.sort((a,b)=> (b.createdAt||0)-(a.createdAt||0)); coursesCache = arr; renderCourses(arr);
  }, err => { console.warn('DB read error', err); toast('Erro ao carregar cursos — verifique a conexão'); });
}

function renderCourses(list){
  coursesEl.innerHTML=''; if(!list || !list.length){ noneEl.classList.remove('hidden'); return; }
  list.forEach(c=>{
    const card=document.createElement('div'); card.className='card';
    card.innerHTML = `<div style="display:flex;gap:12px;align-items:center">
      <div style="width:120px;height:76px;border-radius:8px;overflow:hidden;background:#081226;border:1px solid rgba(255,255,255,0.02)">${c.thumbnailUrl?`<img src="${c.thumbnailUrl}" style="width:100%;height:100%;object-fit:cover">`:'<div style="padding:10px;color:var(--muted)">Sem imagem</div>'}</div>
      <div style="flex:1">
        <div style="font-weight:800">${escapeHtml(c.nome)}</div>
        <div class="muted small">${escapeHtml(truncate(c.descricao,120))}</div>
        <div style="margin-top:8px"><span class="muted small">${c.nivel||''}</span> <span class="muted small">• ${c.tags?.slice(0,3).join(', ')}</span></div>
      </div>
    </div>`;
    const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px'; actions.style.marginTop='10px';
    const addBtn = document.createElement('button'); addBtn.className='btn small'; addBtn.textContent='➕ Adicionar Módulo'; addBtn.onclick = ()=> openModuleModal(c);
    actions.appendChild(addBtn);
    if(c.link){ const linkA=document.createElement('a'); linkA.href=c.link; linkA.target='_blank'; linkA.className='btn ghost small'; linkA.textContent='Abrir link'; actions.appendChild(linkA); }
    const meta=document.createElement('div'); meta.style.marginLeft='auto'; meta.innerHTML=`<div class="muted small">Criado: ${fmt(c.createdAt)}</div>`; actions.appendChild(meta);
    card.appendChild(actions);
    const modulesDiv=document.createElement('div'); modulesDiv.style.marginTop='12px'; modulesDiv.className='modules'; modulesDiv.id='mods_'+c._id; card.appendChild(modulesDiv);
    coursesEl.appendChild(card); loadModulesForCourse(c._id, modulesDiv);
  });
}

function loadModulesForCourse(courseId, container){
  container.innerHTML = '<div class="muted small">Carregando módulos...</div>';
  db.ref(`cursos/${courseId}/modulos`).orderByChild('createdAt').once('value').then(snap => {
    const mods=[]; snap.forEach(child=>{ const m=child.val(); m._id = child.key; mods.push(m); });
    mods.sort((a,b)=> (a.createdAt||0)-(b.createdAt||0)); container.innerHTML=''; if(!mods.length){ container.innerHTML = '<div class="muted small">Nenhum módulo</div>'; return; }
    mods.forEach(m=>{ const mc=document.createElement('div'); mc.className='mcard'; mc.innerHTML = `<div style="height:80px;overflow:hidden;border-radius:6px">${m.imageUrl?`<img src="${m.imageUrl}" style="width:100%;height:100%;object-fit:cover">`:'<div style="padding:10px;color:var(--muted)">Sem imagem</div>'}</div><div style="font-weight:700;margin-top:6px">${escapeHtml(m.titulo||'Sem título')}</div><div class="muted small">${truncate(m.texto||'',80)}</div>${m.link?`<div style="margin-top:6px"><a href="${m.link}" target="_blank" class="muted small">${truncate(m.link,40)}</a></div>`:''}`; container.appendChild(mc); });
  }).catch(e=>{ console.warn('modules load err', e); container.innerHTML = '<div class="muted small">Erro ao carregar módulos</div>'; });
}

/* ---------------- MODULE MODAL ---------------- */
function openModuleModal(course){
  const u = auth.currentUser; if(!u || u.isAnonymous){ alert('Você precisa estar logado com conta (email/google) para adicionar módulos.'); return; }
  currentCourseForModule = course; moduleCourseName.textContent = course.nome; moduleModal.style.display='flex';
  modTitulo.value=''; modTexto.value=''; modLink.value=''; modFile.value=''; modImageFile.value=''; modImageUrl.value=''; modPreview.innerHTML=''; tempModuleImage=null;
}
modalCancel.addEventListener('click', ()=>{ moduleModal.style.display='none'; currentCourseForModule=null; tempModuleImage=null; });

modImageFile.addEventListener('change', ()=>{ const f = modImageFile.files[0]; if(!f){ modPreview.innerHTML=''; tempModuleImage=null; return; } if(!f.type.startsWith('image/')){ alert('Selecione imagem'); return; } tempModuleImage=f; const url = URL.createObjectURL(f); modPreview.innerHTML=`<img src="${url}" style="width:100%;height:100%;object-fit:cover">`; });
modImageUrl.addEventListener('input', ()=>{ const v=(modImageUrl.value||'').trim(); if(!v){ if(!tempModuleImage) modPreview.innerHTML=''; return; } modPreview.innerHTML=`<img src="${v}" style="width:100%;height:100%;object-fit:cover">`; });

modalSave.addEventListener('click', async ()=>{
  if(!currentCourseForModule) return alert('Nenhum curso selecionado'); const titulo=(modTitulo.value||'').trim(), texto=(modTexto.value||'').trim(), link=(modLink.value||'').trim(); const u = auth.currentUser;
  if(!u || u.isAnonymous) return alert('Você precisa estar logado para adicionar módulo.');
  if(!titulo && !texto && !modFile.files.length) { alert('Forneça título, texto ou arquivo'); return; }
  modalSave.disabled=true; modalSave.textContent='Salvando...';
  try{
    const payload={ titulo, texto, link, createdAt: Date.now() };
    if(tempModuleImage){
      const f = tempModuleImage; if(f.size > 25*1024*1024) throw new Error('Imagem muito grande (max 25MB)');
      const resized = await resizeImageFile(f,1280,720,0.82); modProgress.classList.remove('hidden'); modProgressBar.style.width='0%';
      const path = `modulos-imagens/${u.uid}/${currentCourseForModule._id}/${Date.now()}_${f.name.replace(/\s/g,'_')}`;
      const url = await uploadWithProgress(path, resized, pct => modProgressBar.style.width = pct + '%'); payload.imageUrl = url; modProgress.classList.add('hidden');
    } else if(modImageUrl.value.trim()){ payload.imageUrl = modImageUrl.value.trim(); }
    if(modFile.files.length){
      const f2 = modFile.files[0]; const path2 = `modulos-files/${u.uid}/${currentCourseForModule._id}/${Date.now()}_${f2.name.replace(/\s/g,'_')}`; modProgress.classList.remove('hidden'); modProgressBar.style.width='0%';
      const url2 = await uploadWithProgress(path2, f2, pct => modProgressBar.style.width = pct + '%'); payload.fileUrl = url2; modProgress.classList.add('hidden');
    }
    await db.ref(`cursos/${currentCourseForModule._id}/modulos`).push(payload);
    toast('Módulo criado com sucesso!'); const cont = document.getElementById('mods_' + currentCourseForModule._id); if(cont) loadModulesForCourse(currentCourseForModule._id, cont);
    moduleModal.style.display='none'; currentCourseForModule=null;
  }catch(e){ console.error(e); alert('Erro ao salvar módulo: ' + (e.message || e)); }
  finally{ modalSave.disabled=false; modalSave.textContent='Salvar'; modProgress.classList.add('hidden'); modProgressBar.style.width='0%'; }
});

/* ---------------- INIT ---------------- */
(function init(){
  if(!auth.currentUser) auth.signInAnonymously().catch(()=>{});
  btnRefresh.addEventListener('click', ()=> loadCourses());
  btnMeus.addEventListener('click', ()=> {
    const u = auth.currentUser; if(!u || u.isAnonymous) return toast('Faça login para ver seus cursos.'); const mine = coursesCache.filter(c=> c.authorId === u.uid); if(!mine.length) toast('Você não publicou cursos ainda.'); renderCourses(mine);
  });
  authPass.addEventListener('keydown', e => { if(e.key === 'Enter') btnLogin.click(); });
})();
</script>
</body>
</html>
