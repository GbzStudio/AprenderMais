<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AprenderMais — Criar & Módulos</title>
  <style>
    :root{
      --bg:#071226; --card:#061424; --accent:#4f46e5; --accent-2:#06b6d4; --muted:#94a3b8;
      --glass:rgba(255,255,255,0.02); --radius:12px; --maxw:1200px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Arial;color:#e6eef8;background:linear-gradient(180deg,#071022,#061218);-webkit-font-smoothing:antialiased;padding:22px}
    .wrap{max-width:var(--maxw);margin:0 auto}
    header{display:flex;align-items:center;gap:12px;margin-bottom:18px}
    .logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--accent-2),var(--accent));display:flex;align-items:center;justify-content:center;font-weight:800}
    h1{margin:0;font-size:20px}
    .note{color:var(--muted);font-size:13px}
    nav.top{margin-left:auto;display:flex;gap:8px;align-items:center}
    .btn{background:var(--accent);border:none;color:white;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
    .panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
    label{display:block;font-size:13px;color:var(--muted);margin-top:10px}
    input,textarea,select{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit}
    textarea{min-height:110px;resize:vertical}
    .layout{display:grid;grid-template-columns:1fr 380px;gap:18px}
    @media(max-width:980px){.layout{grid-template-columns:1fr}}
    .thumb-preview{height:180px;border-radius:10px;background:#081226;border:1px dashed rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:center;overflow:hidden}
    .my-courses{margin-top:14px}
    .course-row{display:flex;align-items:center;gap:8px;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);margin-bottom:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
    .course-row img{width:64px;height:48px;object-fit:cover;border-radius:6px}
    .course-actions{display:flex;gap:8px}
    .modules-list{margin-top:12px}
    .module-card{padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);margin-bottom:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
    .module-header{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .muted{color:var(--muted)}
    .small{font-size:13px;color:var(--muted)}
    .flex{display:flex;gap:8px;align-items:center}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">AM</div>
      <div>
        <h1>Criar & Gerenciar Cursos</h1>
        <div class="note">Publique cursos, adicione módulos com imagens/arquivos e links — tudo salvo no Firebase.</div>
      </div>

      <nav class="top">
        <a class="btn ghost" href="index.html">Início</a>
        <a class="btn ghost" href="sobre.html">Mais Sites</a>
        <button id="authBtn" class="btn">Conectar</button>
      </nav>
    </header>

    <div class="layout">
      <!-- LEFT: create/edit curso + modules -->
      <main>
        <div class="panel" id="coursePanel">
          <h2 id="panelTitle">Novo curso</h2>

          <label>Nome do curso</label>
          <input id="nome" placeholder="Ex: Introdução ao HTML e CSS" />

          <label>Descrição</label>
          <textarea id="descricao" placeholder="Descrição breve do curso"></textarea>

          <label>Tags (separadas por vírgula)</label>
          <input id="tags" placeholder="web,frontend,html" />

          <label>Nível</label>
          <select id="nivel">
            <option>Iniciante</option>
            <option>Intermediário</option>
            <option>Avançado</option>
          </select>

          <label>Link externo (opcional)</label>
          <input id="link" placeholder="https://..." />

          <label>Thumbnail (arquivo ou URL)</label>
          <div style="display:flex;gap:8px;align-items:center">
            <input type="file" id="thumbFile" accept="image/*" />
            <input id="thumbUrl" placeholder="Ou cole uma URL de imagem" style="flex:1" />
          </div>

          <div style="margin-top:12px;display:flex;gap:8px">
            <button id="salvarCurso" class="btn">Publicar Curso</button>
            <button id="atualizarCurso" class="btn ghost">Salvar edição</button>
            <button id="renomearCurso" class="btn ghost">Renomear</button>
            <button id="excluirCurso" class="btn" style="background:#dc2626">Excluir</button>
            <button id="limparCurso" class="btn ghost">Limpar</button>
          </div>

          <div id="cursoStatus" class="small" style="margin-top:10px"></div>
        </div>

        <!-- modules area (shows when a course is selected) -->
        <div class="panel" id="modulesPanel" style="margin-top:14px;display:none">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <h3 id="modulesTitle">Módulos</h3>
              <div class="muted small" id="modulesSub">Gerencie módulos deste curso</div>
            </div>
            <div class="flex">
              <button id="btnCriarModulo" class="btn">+ Criar Módulo</button>
            </div>
          </div>

          <div id="modulesList" class="modules-list"></div>
        </div>
      </main>

      <!-- RIGHT: preview + meus cursos -->
      <aside>
        <div class="panel">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="small">Thumbnail preview</div>
              <div class="muted small">Upload ou cole URL</div>
            </div>
            <div><button id="openIndex" class="btn ghost">Ver site</button></div>
          </div>
          <div class="thumb-preview" id="thumbPreview" style="margin-top:10px">Nenhuma imagem</div>
          <div class="small" style="margin-top:8px">Tamanho sugerido: 1280×720 • jpg/png</div>
        </div>

        <div class="panel" style="margin-top:12px">
          <h3>Seus cursos</h3>
          <div id="myList" class="my-courses">Carregando…</div>
        </div>
      </aside>
    </div>
  </div>

  <!-- Modal: criar/editar módulo -->
  <div id="moduleModal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(0deg,rgba(0,0,0,0.6),rgba(0,0,0,0.6));z-index:90;padding:18px">
    <div style="width:980px;max-width:100%;background:linear-gradient(180deg,#071224,#061622);border-radius:12px;padding:18px;border:1px solid rgba(255,255,255,0.04);color:#e6eef8">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong id="modalTitle">Novo módulo</strong>
        <div style="display:flex;gap:8px">
          <button id="saveModule" class="btn">Salvar módulo</button>
          <button id="cancelModule" class="btn ghost">Cancelar</button>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 320px;gap:12px;margin-top:12px">
        <div>
          <label>Título do módulo</label>
          <input id="modTitulo" placeholder="Ex: Aula 1 — Conceitos básicos" />

          <label>Conteúdo / Texto</label>
          <textarea id="modTexto" placeholder="Conteúdo do módulo (ou faça upload de um arquivo)"></textarea>

          <label>Link opcional (YouTube, Drive, etc.)</label>
          <input id="modLink" placeholder="https://..." />

          <label style="margin-top:8px">Upload arquivo de texto / PDF (opcional)</label>
          <input type="file" id="modFile" accept=".txt,application/pdf,application/*" />
        </div>

        <div>
          <label>Imagem do módulo (upload ou URL)</label>
          <input type="file" id="modImageFile" accept="image/*" />
          <input id="modImageUrl" placeholder="Ou cole URL da imagem" style="margin-top:8px" />
          <div class="thumb-preview" id="modImagePreview" style="margin-top:8px">Nenhuma imagem</div>

          <label style="margin-top:10px">Arquivo extra (opcional)</label>
          <input type="file" id="modExtraFile" />
          <div id="modFileList" class="small"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase libs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <script>
  /* =========== CONFIG FIREBASE =========== */
  const firebaseConfig = {
    apiKey: "AIzaSyALpPt-tUWB0Gq-UeJXOJRRkyt0si8s4Nc",
    authDomain: "fir-auth-3521c.firebaseapp.com",
    databaseURL: "https://fir-auth-3521c-default-rtdb.firebaseio.com",
    projectId: "fir-auth-3521c",
    storageBucket: "fir-auth-3521c.firebasestorage.app",
    messagingSenderId: "873308453565",
    appId: "1:873308453565:web:4ff8d9863adb1eae1c95d4",
    measurementId: "G-LWMZJ55W7N"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth(), db = firebase.database(), storage = firebase.storage();

  /* =========== HELPERS UI =========== */
  function toast(msg, t=2200){ const d=document.createElement('div'); d.textContent=msg; d.style.cssText="position:fixed;right:18px;bottom:18px;background:#111;padding:12px 16px;border-radius:10px;color:white;z-index:120"; document.body.appendChild(d); setTimeout(()=>d.style.opacity='0',t); setTimeout(()=>d.remove(),t+420); }
  function formatDate(ts){ try{return new Date(ts).toLocaleString();}catch(e){return '-'} }

  /* =========== STATE =========== */
  let me = null;
  let editCourseId = null; // current selected course (for modules)
  let editModuleId = null;
  let moduleTempFiles = {};

  /* =========== ELEMENTS =========== */
  const nomeEl = document.getElementById('nome'), descEl = document.getElementById('descricao'), tagsEl = document.getElementById('tags');
  const nivelEl = document.getElementById('nivel'), linkEl = document.getElementById('link');
  const thumbFileEl = document.getElementById('thumbFile'), thumbUrlEl = document.getElementById('thumbUrl'), thumbPreview = document.getElementById('thumbPreview');
  const salvarCursoBtn = document.getElementById('salvarCurso'), atualizarCursoBtn = document.getElementById('atualizarCurso'), renomearBtn = document.getElementById('renomearCurso');
  const excluirCursoBtn = document.getElementById('excluirCurso'), limparCursoBtn = document.getElementById('limparCurso');
  const cursoStatus = document.getElementById('cursoStatus');
  const myList = document.getElementById('myList');

  const modulesPanel = document.getElementById('modulesPanel'), modulesList = document.getElementById('modulesList'), btnCriarModulo = document.getElementById('btnCriarModulo');
  const modulesTitle = document.getElementById('modulesTitle'), modulesSub = document.getElementById('modulesSub');

  // modal elements
  const moduleModal = document.getElementById('moduleModal'), modalTitle = document.getElementById('modalTitle');
  const modTitulo = document.getElementById('modTitulo'), modTexto = document.getElementById('modTexto');
  const modLink = document.getElementById('modLink'), modFile = document.getElementById('modFile');
  const modImageFile = document.getElementById('modImageFile'), modImageUrl = document.getElementById('modImageUrl'), modImagePreview = document.getElementById('modImagePreview');
  const modExtraFile = document.getElementById('modExtraFile'), modFileList = document.getElementById('modFileList');
  const saveModuleBtn = document.getElementById('saveModule'), cancelModuleBtn = document.getElementById('cancelModule');
  const openIndexBtn = document.getElementById('openIndex');

  /* =========== AUTH =========== */
  auth.onAuthStateChanged(u=>{
    me = u;
    const authBtn = document.getElementById('authBtn');
    if (!u) { authBtn.textContent='Conectar'; }
    else { authBtn.textContent='Conectado'; loadMyCourses(); }
  });
  document.getElementById('authBtn').addEventListener('click', async ()=>{
    if (!auth.currentUser) {
      try { await auth.signInAnonymously(); toast('Conectado anonimamente'); }
      catch(e){ toast('Erro: '+e.message); }
    } else { auth.signOut(); toast('Desconectado'); }
  });

  /* =========== PREVIEWS =========== */
  thumbFileEl.addEventListener('change', ()=> {
    const f = thumbFileEl.files[0];
    if (!f){ if (!thumbUrlEl.value) thumbPreview.innerHTML='Nenhuma imagem'; return; }
    const u = URL.createObjectURL(f);
    thumbPreview.innerHTML = `<img src="${u}" style="width:100%;height:100%;object-fit:cover">`;
  });
  thumbUrlEl.addEventListener('input', ()=> {
    const v = thumbUrlEl.value.trim();
    if (!v){ if (!thumbFileEl.files.length) thumbPreview.innerHTML='Nenhuma imagem'; return; }
    thumbPreview.innerHTML = `<img src="${v}" style="width:100%;height:100%;object-fit:cover">`;
  });

  modImageFile.addEventListener('change', ()=> {
    const f = modImageFile.files[0];
    if (!f){ if (!modImageUrl.value) modImagePreview.innerHTML='Nenhuma imagem'; return; }
    moduleTempFiles.image = f;
    const u = URL.createObjectURL(f);
    modImagePreview.innerHTML = `<img src="${u}" style="width:100%;height:100%;object-fit:cover">`;
  });
  modImageUrl.addEventListener('input', ()=> {
    const v = modImageUrl.value.trim();
    if (!v){ if (!moduleTempFiles.image) modImagePreview.innerHTML='Nenhuma imagem'; return; }
    modImagePreview.innerHTML = `<img src="${v}" style="width:100%;height:100%;object-fit:cover">`;
  });
  modFile.addEventListener('change', ()=> {
    if (modFile.files.length) { moduleTempFiles.textFile = modFile.files[0]; modFileList.innerHTML = `<div>${moduleTempFiles.textFile.name} (pronto)</div>`; }
  });
  modExtraFile.addEventListener('change', ()=> {
    if (modExtraFile.files.length) { moduleTempFiles.extraFile = modExtraFile.files[0]; modFileList.innerHTML += `<div>${moduleTempFiles.extraFile.name} (pronto)</div>`; }
  });

  /* =========== CRUD Cursos =========== */
  async function createCourse(){
    const nome = nomeEl.value.trim();
    const descricao = descEl.value.trim();
    const tags = tagsEl.value.split(',').map(s=>s.trim()).filter(Boolean);
    const nivel = nivelEl.value;
    const link = linkEl.value.trim();
    if (!nome || !descricao){ alert('Preencha nome e descrição'); return; }
    if (!me){ alert('Aguarde autenticação...'); return; }

    salvarCursoBtn.disabled = true; cursoStatus.textContent = 'Salvando...';
    try {
      let thumbnailUrl = thumbUrlEl.value.trim() || null;
      if (thumbFileEl.files.length > 0){
        const f = thumbFileEl.files[0];
        const path = `thumbnails/${me.uid}/${Date.now()}_${f.name}`;
        const ref = storage.ref().child(path);
        await ref.put(f);
        thumbnailUrl = await ref.getDownloadURL();
      }

      const payload = {
        nome, descricao, tags, nivel, link,
        thumbnailUrl: thumbnailUrl || null,
        authorId: me.uid,
        authorName: 'Anônimo',
        createdAt: Date.now()
      };
      const ref = db.ref('cursos').push();
      await ref.set(payload);
      toast('Curso criado — agora você pode adicionar módulos.');
      limparForm();
      loadMyCourses();
    } catch(e){ console.error(e); alert('Erro ao criar curso: '+e.message); }
    finally { salvarCursoBtn.disabled = false; cursoStatus.textContent = ''; }
  }

  salvarCursoBtn.addEventListener('click', ()=> {
    // if editCourseId is set and user clicked salvarCurso, treat as create new unless they used "Salvar edição"
    if (editCourseId) {
      if (!confirm('Você está editando um curso. Clique "Salvar edição" para atualizar o curso atual. Deseja criar um novo curso mesmo assim?')) return;
    }
    createCourse();
  });

  async function loadMyCourses(){
    if (!me) return;
    myList.innerHTML = 'Carregando...';
    db.ref('cursos').orderByChild('authorId').equalTo(me.uid).on('value', snap=>{
      const arr = [];
      snap.forEach(child=>{
        const c = child.val(); c._id = child.key;
        arr.push(c);
      });
      renderMyCourses(arr);
    });
  }

  function renderMyCourses(arr){
    myList.innerHTML = '';
    if (!arr.length){ myList.innerHTML = '<div class="muted small">Você ainda não publicou cursos.</div>'; return; }
    arr.sort((a,b)=> (b.createdAt||0)-(a.createdAt||0));
    arr.forEach(c=>{
      const row = document.createElement('div'); row.className='course-row';
      const img = document.createElement('img'); img.src = c.thumbnailUrl || '';
      row.appendChild(img);

      const info = document.createElement('div'); info.style.flex='1';
      info.innerHTML = `<div style="font-weight:700">${c.nome}</div><div class="muted small">${(c.tags||[]).join(', ')} • ${c.nivel}</div><div class="muted small">Criado: ${formatDate(c.createdAt||0)}</div>`;
      row.appendChild(info);

      const actions = document.createElement('div'); actions.className='course-actions';
      const manage = document.createElement('button'); manage.className='btn ghost'; manage.textContent='Gerenciar';
      manage.onclick = ()=> openCourseManager(c._id);
      const edit = document.createElement('button'); edit.className='btn ghost'; edit.textContent='Editar';
      edit.onclick = ()=> loadCourseToEdit(c._id);
      const del = document.createElement('button'); del.className='btn'; del.style.background='#dc2626'; del.textContent='Excluir';
      del.onclick = ()=> deleteCourse(c._id);
      actions.appendChild(manage); actions.appendChild(edit); actions.appendChild(del);
      row.appendChild(actions);

      myList.appendChild(row);
    });
  }

  async function loadCourseToEdit(id){
    try{
      const snap = await db.ref(`cursos/${id}`).once('value');
      const c = snap.val();
      if (!c) return alert('Curso não encontrado.');
      editCourseId = id;
      panelTitle.textContent = 'Editando curso';
      nomeEl.value = c.nome || '';
      descEl.value = c.descricao || '';
      tagsEl.value = (c.tags||[]).join(', ');
      nivelEl.value = c.nivel || 'Iniciante';
      linkEl.value = c.link || '';
      if (c.thumbnailUrl) thumbPreview.innerHTML = `<img src="${c.thumbnailUrl}" style="width:100%;height:100%;object-fit:cover">`;
      modulesPanel.style.display = 'block';
      modulesTitle.textContent = `Módulos: ${c.nome}`;
      modulesSub.textContent = `Gerenciando os módulos do curso — ${c.nome}`;
      loadModulesForCourse(id);
      window.scrollTo({top:0,behavior:'smooth'});
    }catch(e){ alert('Erro ao carregar curso: '+e.message); }
  }

  async function openCourseManager(id){
    // same as loadCourseToEdit but stays explicit
    await loadCourseToEdit(id);
  }

  async function updateCourse(){
    if (!editCourseId) return alert('Nenhum curso selecionado para atualizar (use Gerenciar).');
    try{
      const nome = nomeEl.value.trim(), descricao = descEl.value.trim(), tags = tagsEl.value.split(',').map(s=>s.trim()).filter(Boolean), nivel = nivelEl.value, link = linkEl.value.trim();
      let thumbnailUrl = thumbUrlEl.value.trim() || null;
      if (thumbFileEl.files.length > 0){
        const f = thumbFileEl.files[0];
        const path = `thumbnails/${me.uid}/${Date.now()}_${f.name}`;
        const ref = storage.ref().child(path);
        await ref.put(f);
        thumbnailUrl = await ref.getDownloadURL();
      }
      const payload = { nome, descricao, tags, nivel, link };
      if (thumbnailUrl) payload.thumbnailUrl = thumbnailUrl;
      await db.ref(`cursos/${editCourseId}`).update(payload);
      toast('Curso atualizado.');
      loadMyCourses();
    }catch(e){ alert('Erro ao atualizar: '+e.message); }
  }

  atualizarCursoBtn.addEventListener('click', updateCourse);

  renomearBtn.addEventListener('click', async ()=>{
    if (!editCourseId) return alert('Selecione um curso (Gerenciar) para renomear.');
    const novo = prompt('Novo nome do curso:');
    if (!novo) return;
    try{ await db.ref(`cursos/${editCourseId}`).update({ nome: novo }); toast('Nome atualizado.'); loadMyCourses(); }catch(e){ alert('Erro: '+e.message); }
  });

  async function deleteCourse(id){
    if (!confirm('Excluir este curso e todos os módulos?')) return;
    try{
      await db.ref(`cursos/${id}`).remove();
      toast('Curso excluído.');
      if (editCourseId === id){ editCourseId = null; modulesPanel.style.display='none'; panelTitle.textContent='Novo curso'; }
    }catch(e){ alert('Erro ao excluir: '+e.message); }
  }

  limparCursoBtn.addEventListener('click', ()=> {
    nomeEl.value=''; descEl.value=''; tagsEl.value=''; nivelEl.value='Iniciante'; linkEl.value=''; thumbFileEl.value=''; thumbUrlEl.value=''; thumbPreview.innerHTML='Nenhuma imagem'; editCourseId = null; modulesPanel.style.display='none'; panelTitle.textContent='Novo curso';
  });

  /* =========== MÓDULOS =========== */
  function loadModulesForCourse(courseId){
    modulesList.innerHTML = 'Carregando módulos...';
    db.ref(`cursos/${courseId}/modulos`).orderByChild('createdAt').on('value', snap=>{
      const list = [];
      snap.forEach(child=> { const m = child.val(); m._id = child.key; list.push(m); });
      list.sort((a,b)=> (a.createdAt||0)-(b.createdAt||0));
      renderModules(list);
    });
  }

  function renderModules(list){
    modulesList.innerHTML = '';
    if (!list.length){ modulesList.innerHTML = '<div class="muted small">Nenhum módulo ainda.</div>'; return; }
    list.forEach(m=>{
      const div = document.createElement('div'); div.className='module-card';
      const header = document.createElement('div'); header.className='module-header';
      header.innerHTML = `<strong>${m.titulo || 'Sem título'}</strong><span class="muted small">${formatDate(m.createdAt||0)}</span>`;
      div.appendChild(header);
      if (m.texto) { const p = document.createElement('div'); p.className='muted'; p.style.marginTop='8px'; p.textContent = m.texto; div.appendChild(p); }
      if (m.imageUrl) { const imgWrap = document.createElement('div'); imgWrap.style.marginTop='8px'; imgWrap.innerHTML = `<div style="height:140px;overflow:hidden;border-radius:8px"><img src="${m.imageUrl}" style="width:100%;height:100%;object-fit:cover"></div>`; div.appendChild(imgWrap); }
      if (m.fileUrl) { const fline = document.createElement('div'); fline.style.marginTop='8px'; fline.innerHTML = `<div class="small muted">Arquivo: <a href="${m.fileUrl}" target="_blank">${m.fileUrl}</a></div>`; div.appendChild(fline); }
      if (m.link) { const l = document.createElement('div'); l.style.marginTop='8px'; l.innerHTML = `<div class="small muted">Link: <a href="${m.link}" target="_blank">${m.link}</a></div>`; div.appendChild(l); }

      // actions
      const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px'; actions.style.marginTop='10px';
      const editBtn = document.createElement('button'); editBtn.className='btn ghost'; editBtn.textContent='Editar'; editBtn.onclick = ()=> openModuleEdit(m._id, m);
      const delBtn = document.createElement('button'); delBtn.className='btn'; delBtn.style.background='#dc2626'; delBtn.textContent='Excluir'; delBtn.onclick = ()=> deleteModule(m._id);
      actions.appendChild(editBtn); actions.appendChild(delBtn);
      div.appendChild(actions);

      modulesList.appendChild(div);
    });
  }

  /* abrir modal para criar módulo */
  btnCriarModulo.addEventListener('click', ()=>{
    if (!editCourseId){ alert('Selecione/abra um curso (Gerenciar) antes de criar módulos.'); return; }
    editModuleId = null;
    openModuleModal();
  });

  function openModuleModal(){
    moduleTempFiles = {};
    modTitulo.value = ''; modTexto.value = ''; modLink.value=''; modFile.value=''; modImageFile.value=''; modImageUrl.value=''; modImagePreview.innerHTML='Nenhuma imagem'; modExtraFile.value=''; modFileList.innerHTML='';
    modalTitle.textContent = editModuleId ? 'Editar módulo' : 'Novo módulo';
    moduleModal.style.display = 'flex';
  }

  cancelModuleBtn.addEventListener('click', ()=> { moduleModal.style.display='none'; editModuleId = null; moduleTempFiles = {}; });

  async function openModuleEdit(moduleId, moduleObj){
    editModuleId = moduleId;
    openModuleModal();
    // prefill
    modTitulo.value = moduleObj.titulo || '';
    modTexto.value = moduleObj.texto || '';
    modLink.value = moduleObj.link || '';
    if (moduleObj.imageUrl) { modImageUrl.value = moduleObj.imageUrl; modImagePreview.innerHTML = `<img src="${moduleObj.imageUrl}" style="width:100%;height:100%;object-fit:cover">`; }
    if (moduleObj.fileUrl) modFileList.innerHTML = `<div class="small muted">Arquivo salvo: <a href="${moduleObj.fileUrl}" target="_blank">${moduleObj.fileUrl}</a></div>`;
  }

  async function deleteModule(moduleId){
    if (!confirm('Excluir módulo permanentemente?')) return;
    try{
      await db.ref(`cursos/${editCourseId}/modulos/${moduleId}`).remove();
      toast('Módulo excluído.');
    }catch(e){ alert('Erro: '+e.message); }
  }

  /* salvar módulo (upload de arquivos se houver) */
  saveModuleBtn.addEventListener('click', async ()=>{
    const titulo = modTitulo.value.trim();
    const texto = modTexto.value.trim();
    const link = modLink.value.trim();
    if (!titulo && !texto && !moduleTempFiles.textFile){ alert('Informe título ou conteúdo (ou faça upload).'); return; }
    if (!editCourseId){ alert('Nenhum curso selecionado.'); return; }

    saveModuleBtn.disabled = true; saveModuleBtn.textContent = 'Salvando...';
    try{
      const payload = { titulo, texto, link, createdAt: Date.now() };

      // image upload priority: file upload > URL
      if (moduleTempFiles.image){
        const f = moduleTempFiles.image;
        const path = `modules/${me.uid}/${editCourseId}/images/${Date.now()}_${f.name}`;
        const ref = storage.ref().child(path);
        await ref.put(f);
        payload.imageUrl = await ref.getDownloadURL();
      } else if (modImageUrl.value.trim()){
        payload.imageUrl = modImageUrl.value.trim();
      }

      // text file upload
      if (moduleTempFiles.textFile){
        const f = moduleTempFiles.textFile;
        const path = `modules/${me.uid}/${editCourseId}/files/${Date.now()}_${f.name}`;
        const ref = storage.ref().child(path);
        await ref.put(f);
        payload.fileUrl = await ref.getDownloadURL();
      }

      // extra file upload
      if (moduleTempFiles.extraFile){
        const f = moduleTempFiles.extraFile;
        const path = `modules/${me.uid}/${editCourseId}/extras/${Date.now()}_${f.name}`;
        const ref = storage.ref().child(path);
        await ref.put(f);
        payload.extraFileUrl = await ref.getDownloadURL();
      }

      if (editModuleId){
        await db.ref(`cursos/${editCourseId}/modulos/${editModuleId}`).update(payload);
        toast('Módulo atualizado.');
      } else {
        await db.ref(`cursos/${editCourseId}/modulos`).push(payload);
        toast('Módulo criado.');
      }

      moduleModal.style.display = 'none';
      moduleTempFiles = {};
    }catch(e){ console.error(e); alert('Erro ao salvar módulo: '+e.message); }
    finally{ saveModuleBtn.disabled = false; saveModuleBtn.textContent = 'Salvar módulo'; }
  });

  /* =========== fluxos úteis =========== */
  openIndexBtn.addEventListener('click', ()=> window.location.href = 'index.html');

  /* carregar módulos quando curso selecionado:
     loadCourseToEdit() já chama loadModulesForCourse()
  */

  /* =========== inicialização: carregar usuario anonimo e dados básicos =========== */
  (function init(){
    // ensure anonymous auth
    if (!auth.currentUser) {
      auth.signInAnonymously().catch(()=>{});
    }
  })();

  </script>
</body>
</html>
