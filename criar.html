<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>AprenderMais ‚Äî Criar Cursos (UI Antiga)</title>
<meta name="description" content="Criar curso - AprenderMais. UI antiga com painel lateral neon, adicionar m√≥dulos, Firebase Database + Storage, uploads com progresso e preview.">
<!-- ====== STYLES: UI ANTIGA (painel lateral, neon ciano) ====== -->
<style>
  :root{
    --bg:#050814;
    --panel:#071226;
    --neon1:#06b6d4;
    --neon2:#4f46e5;
    --muted:#94a3b8;
    --card:#081426;
    --glass:rgba(255,255,255,0.03);
    --radius:12px;
    --maxw:1300px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background: linear-gradient(180deg,#020318 0%, #04102a 100%);
    color:#e6eef8;
    -webkit-font-smoothing:antialiased;
  }

  .wrap{max-width:var(--maxw);margin:18px auto;padding:18px}
  header{display:flex;align-items:center;gap:12px;padding:12px;border-radius:12px;background: linear-gradient(90deg, rgba(6,18,30,0.36), rgba(4,14,22,0.36));backdrop-filter: blur(6px);border:1px solid var(--glass)}
  .logo{width:60px;height:60px;border-radius:12px;background:linear-gradient(135deg,var(--neon1),var(--neon2));display:flex;align-items:center;justify-content:center;font-weight:900;color:#fff}
  h1{margin:0;font-size:18px}
  .tag{color:var(--muted);font-size:13px;margin-top:4px}

  .layout{display:grid;grid-template-columns: 1fr 360px;gap:18px;margin-top:16px}
  @media(max-width:980px){ .layout{grid-template-columns:1fr} }

  .panel{
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    padding:14px;border-radius:var(--radius);border:1px solid rgba(255,255,255,0.03);
    box-shadow: 0 8px 24px rgba(2,6,23,0.6);
  }

  label{display:block;font-size:13px;color:var(--muted);margin-top:10px}
  input,textarea,select,button{font-family:inherit}
  input,textarea,select{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit}
  textarea{min-height:100px;resize:vertical}
  .row{display:flex;gap:8px}
  .btn{background:linear-gradient(90deg,var(--neon1),var(--neon2));border:none;color:white;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
  .btn.small{padding:6px 8px;font-size:13px;border-radius:8px}
  .muted{color:var(--muted)}

  /* Course cards area */
  .courses{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:14px;margin-top:12px}
  .course-card{background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column;gap:10px}
  .thumb{width:100%;height:160px;border-radius:8px;background:#081226;overflow:hidden;border:1px solid rgba(255,255,255,0.02)}
  .thumb img{width:100%;height:100%;object-fit:cover}

  /* modules list within create page */
  .modules-list{margin-top:12px;display:flex;flex-direction:column;gap:10px}
  .module-item{
    background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
    border-radius:10px;padding:10px;border:1px solid rgba(255,255,255,0.02);
    display:flex;gap:10px;align-items:flex-start;
    box-shadow: 0 6px 18px rgba(2,6,23,0.45);
  }
  .module-thumb{width:120px;height:72px;border-radius:8px;overflow:hidden;background:#061426;border:1px solid rgba(255,255,255,0.02)}
  .module-thumb img{width:100%;height:100%;object-fit:cover}
  .module-body{flex:1}
  .module-title{font-weight:800}
  .module-desc{color:var(--muted);font-size:13px;margin-top:6px}

  /* modal */
  .modal-back{position:fixed;inset:0;background:linear-gradient(0deg,rgba(0,0,0,0.6),rgba(0,0,0,0.6));display:none;align-items:center;justify-content:center;z-index:200;padding:20px}
  .modal{width:920px;max-width:100%;background:linear-gradient(180deg,#071224,#061622);padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);color:#e6eef8}

  /* small helpers */
  .hidden{display:none}
  .progress{height:8px;background:rgba(255,255,255,0.05);border-radius:999px;overflow:hidden}
  .progress > i{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--neon1),var(--neon2))}

  footer{margin-top:18px;color:var(--muted);font-size:13px;text-align:center}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">AM</div>
      <div>
        <h1>AprenderMais ‚Äî Criar Cursos</h1>
        <div class="tag">UI antiga ‚Äî painel lateral ‚Ä¢ neon ciano</div>
      </div>
      <nav style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <a class="btn ghost" href="index.html">‚¨Ö Voltar</a>
        <a class="btn ghost" href="sobre.html">Mais sites</a>
      </nav>
    </header>

    <div class="layout">
      <!-- MAIN: criar curso -->
      <main>
        <section class="panel" id="createPanel">
          <h2 style="margin:0 0 8px 0">Publicar novo curso</h2>
          <div class="muted small">Preencha os dados abaixo. Adicione m√≥dulos com o bot√£o "Adicionar M√≥dulo".</div>

          <label for="cursoNome">Nome do curso</label>
          <input id="cursoNome" placeholder="Ex: Programa√ß√£o Web para iniciantes" />

          <label for="cursoDescricao">Descri√ß√£o</label>
          <textarea id="cursoDescricao" placeholder="Descri√ß√£o curta do curso"></textarea>

          <label for="cursoTags">Tags (separadas por v√≠rgula)</label>
          <input id="cursoTags" placeholder="ex: web,frontend,html,css" />

          <label for="cursoNivel">N√≠vel</label>
          <select id="cursoNivel">
            <option>Iniciante</option>
            <option>Intermedi√°rio</option>
            <option>Avan√ßado</option>
          </select>

          <label for="cursoLink">Link (opcional)</label>
          <input id="cursoLink" placeholder="Link do curso (opcional) ‚Äî ex: reposit√≥rio, YouTube" />

          <label>Thumbnail do curso (upload ou URL)</label>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="thumbFile" type="file" accept="image/*" />
            <input id="thumbUrl" placeholder="Ou cole uma URL de imagem" style="flex:1" />
          </div>

          <div style="display:flex;gap:8px;align-items:center;margin-top:12px">
            <button id="btnAddModule" class="btn">‚ûï Adicionar M√≥dulo</button>
            <button id="btnPublish" class="btn">üì§ Publicar curso</button>
            <button id="btnClear" class="btn ghost">Limpar</button>
            <div style="margin-left:auto" id="publishStatus" class="muted">Pronto</div>
          </div>

          <!-- modules section (inline) -->
          <div id="modulesArea" class="modules-list" aria-live="polite" style="margin-top:14px"></div>

        </section>

        <!-- published courses preview (bottom) -->
        <section style="margin-top:16px">
          <h3 style="margin:0">Cursos publicados (visualiza√ß√£o)</h3>
          <div id="publishedList" class="courses" style="margin-top:12px"></div>
          <div id="noPublished" class="muted" style="display:none">Nenhum curso publicado ainda.</div>
        </section>
      </main>

      <!-- RIGHT: painel lateral -->
      <aside>
        <section class="panel">
          <h4 style="margin:0">Preview do thumbnail</h4>
          <div id="thumbPreview" class="thumb" style="margin-top:10px"></div>
          <div class="muted small" style="margin-top:8px">Sugest√£o: 1280√ó720. Formatos: jpg, png.</div>
        </section>

        <section class="panel" style="margin-top:12px">
          <h4 style="margin:0">Upload e Progresso</h4>
          <div style="margin-top:10px">
            <div class="muted small">Progresso do upload do thumbnail</div>
            <div class="progress" style="margin-top:6px"><i id="thumbProgress"></i></div>

            <div style="margin-top:12px" class="muted small">Progresso do m√≥dulo atual</div>
            <div class="progress" style="margin-top:6px"><i id="moduleProgress"></i></div>
          </div>
        </section>

        <section class="panel" style="margin-top:12px">
          <h4 style="margin:0">A√ß√µes R√°pidas</h4>
          <div style="display:flex;flex-direction:column;gap:8px;margin-top:10px">
            <button id="btnMyCourses" class="btn ghost small">Meus cursos (filtrar)</button>
            <button id="btnRefresh" class="btn small">Atualizar visual</button>
          </div>
        </section>
      </aside>
    </div>

    <footer>¬© AprenderMais ‚Äî design antigo ‚Ä¢ GbzStudio</footer>
  </div>

  <!-- MODAL: adicionar m√≥dulo detalhado (usado para preenchimento) -->
  <div id="moduleModal" class="modal-back" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <strong id="modalTitle">Adicionar M√≥dulo</strong>
          <div class="muted small" id="modalCourseName">‚Äî</div>
        </div>
        <div style="display:flex;gap:8px">
          <button id="modalSave" class="btn">Salvar m√≥dulo</button>
          <button id="modalCancel" class="btn ghost">Cancelar</button>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 300px;gap:12px;margin-top:12px">
        <div>
          <label>T√≠tulo do m√≥dulo</label>
          <input id="modTitulo" placeholder="Ex: Aula 1 ‚Äî Introdu√ß√£o" />
          <label>Descri√ß√£o / Conte√∫do</label>
          <textarea id="modTexto" placeholder="Texto do m√≥dulo"></textarea>
          <label>Link opcional</label>
          <input id="modLink" placeholder="https://..." />
          <label>Arquivo opcional (pdf, txt, mp4)</label>
          <input id="modFile" type="file" />
        </div>

        <div>
          <label>Imagem do m√≥dulo (upload ou URL)</label>
          <input id="modImageFile" type="file" accept="image/*" />
          <input id="modImageUrl" placeholder="Ou cole URL da imagem" style="margin-top:8px"/>
          <div id="modImagePreview" class="thumb" style="margin-top:10px"></div>
          <div class="muted small" style="margin-top:10px">As imagens s√£o enviadas para <code>/modulos-imagens/</code> no Firebase Storage.</div>
        </div>
      </div>

    </div>
  </div>

  <!-- TOAST container -->
  <div id="toasts" style="position:fixed;right:18px;bottom:18px;z-index:9999"></div>

  <!-- ====== FIREBASE LIBRARIES ====== -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <!-- ====== APP SCRIPT: UI antiga + m√≥dulos + firebase ====== -->
  <script>
  /**
   * criar.html ‚Äî UI antiga
   * - Livre (qualquer pessoa pode publicar)
   * - Cria√ß√£o de curso + m√≥dulos din√¢micos
   * - Upload para Firebase Storage + gravar em Realtime Database
   * - Upload com progresso, resize de imagens no cliente, previews, autosave local e retry queue
   *
   * Observa√ß√£o: N√ÉO inclui hash_config nem dados sens√≠veis do backend.
   */

  // ---------- FIREBASE CONFIG (p√∫blico - ok no client) ----------
  const firebaseConfig = {
    apiKey: "AIzaSyALpPt-tUWB0Gq-UeJXOJRRkyt0si8s4Nc",
    authDomain: "fir-auth-3521c.firebaseapp.com",
    databaseURL: "https://fir-auth-3521c-default-rtdb.firebaseio.com",
    projectId: "fir-auth-3521c",
    storageBucket: "fir-auth-3521c.firebasestorage.app",
    messagingSenderId: "873308453565",
    appId: "1:873308453565:web:4ff8d9863adb1eae1c95d4",
    measurementId: "G-LWMZJ55W7N"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();
  const storage = firebase.storage();

  // ---------- ELEMENTS ----------
  const cursoNome = document.getElementById('cursoNome');
  const cursoDescricao = document.getElementById('cursoDescricao');
  const cursoTags = document.getElementById('cursoTags');
  const cursoNivel = document.getElementById('cursoNivel');
  const cursoLink = document.getElementById('cursoLink');
  const thumbFile = document.getElementById('thumbFile');
  const thumbUrl = document.getElementById('thumbUrl');
  const thumbPreview = document.getElementById('thumbPreview');
  const btnAddModule = document.getElementById('btnAddModule');
  const btnPublish = document.getElementById('btnPublish');
  const btnClear = document.getElementById('btnClear');
  const publishStatus = document.getElementById('publishStatus');
  const modulesArea = document.getElementById('modulesArea');
  const publishedList = document.getElementById('publishedList');
  const noPublished = document.getElementById('noPublished');

  const thumbProgressBar = document.getElementById('thumbProgress');
  const moduleProgressBar = document.getElementById('moduleProgress');

  const moduleModal = document.getElementById('moduleModal');
  const modalSave = document.getElementById('modalSave');
  const modalCancel = document.getElementById('modalCancel');
  const modTitulo = document.getElementById('modTitulo');
  const modTexto = document.getElementById('modTexto');
  const modLink = document.getElementById('modLink');
  const modFile = document.getElementById('modFile');
  const modImageFile = document.getElementById('modImageFile');
  const modImageUrl = document.getElementById('modImageUrl');
  const modImagePreview = document.getElementById('modImagePreview');

  const btnRefresh = document.getElementById('btnRefresh');
  const btnMyCourses = document.getElementById('btnMyCourses');

  const toasts = document.getElementById('toasts');

  // ---------- STATE ----------
  let modulesTemp = []; // array of module objects in form { id, titulo, texto, link, imageFile, imageUrl, file }
  let currentModalForIndex = null; // index in modulesTemp being edited
  let publishedCache = []; // preview cache of published courses
  let uploadQueue = []; // queue for retry uploads (simple implementation)
  let isPublishing = false;

  // ---------- UTIL HELPERS ----------
  function toast(msg, ms=2500){
    const el = document.createElement('div');
    el.textContent = msg;
    el.style.cssText = 'background:linear-gradient(90deg,var(--neon1),var(--neon2));padding:10px 12px;border-radius:8px;color:#04101a;margin-top:8px;box-shadow:0 6px 18px rgba(0,0,0,0.4);font-weight:700';
    toasts.appendChild(el);
    setTimeout(()=> el.style.opacity='0', ms);
    setTimeout(()=> el.remove(), ms+300);
  }

  function safeText(v){ return (v||'').toString().trim(); }
  function uid(){ return 'id_' + Date.now() + '_' + Math.random().toString(36).slice(2,8); }

  // debounce
  function debounce(fn, ms=250){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=> fn(...a), ms); }; }

  // escape html for safety in previews
  function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[ch]); }

  // image resize helper (returns Blob) - uses canvas
  async function resizeImageFile(file, maxWidth=1280, maxHeight=720, quality=0.82){
    return new Promise((resolve, reject) => {
      if (!file) return resolve(null);
      const img = new Image();
      const url = URL.createObjectURL(file);
      img.onload = () => {
        let w = img.naturalWidth, h = img.naturalHeight;
        const ratio = Math.min(1, maxWidth / w, maxHeight / h);
        w = Math.round(w * ratio);
        h = Math.round(h * ratio);
        const canvas = document.createElement('canvas');
        canvas.width = w;
        canvas.height = h;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, w, h);
        canvas.toBlob(blob => {
          URL.revokeObjectURL(url);
          if (!blob) return reject(new Error('Falha ao redimensionar imagem'));
          resolve(blob);
        }, 'image/jpeg', quality);
      };
      img.onerror = (e) => { URL.revokeObjectURL(url); reject(e); };
      img.src = url;
    });
  }

  // upload with progress -> returns downloadURL
  function uploadWithProgress(storagePath, fileOrBlob, onProgress){
    const ref = storage.ref().child(storagePath);
    const task = ref.put(fileOrBlob);
    return new Promise((resolve, reject) => {
      task.on('state_changed', snapshot => {
        const pct = Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
        if (onProgress) onProgress(pct);
      }, err => {
        reject(err);
      }, async () => {
        try {
          const url = await task.snapshot.ref.getDownloadURL();
          resolve(url);
        } catch(e){ reject(e); }
      });
    });
  }

  // save autosave to localStorage (for recovery)
  function autosaveLocal(){
    try {
      const state = {
        cursoNome: cursoNome.value,
        cursoDescricao: cursoDescricao.value,
        cursoTags: cursoTags.value,
        cursoNivel: cursoNivel.value,
        cursoLink: cursoLink.value,
        modules: modulesTemp.map(m => ({
          id: m.id, titulo: m.titulo, texto: m.texto, link: m.link, imageUrl: m.imageUrl || null
        }))
      };
      localStorage.setItem('apm_autosave', JSON.stringify(state));
      // little subtle status
      publishStatus.textContent = 'Autosave local salvo';
    } catch(e){ console.warn('autosave err', e); }
  }

  function loadAutosave(){
    try {
      const raw = localStorage.getItem('apm_autosave');
      if(!raw) return;
      const s = JSON.parse(raw);
      cursoNome.value = s.cursoNome || '';
      cursoDescricao.value = s.cursoDescricao || '';
      cursoTags.value = s.cursoTags || '';
      cursoNivel.value = s.cursoNivel || 'Iniciante';
      cursoLink.value = s.cursoLink || '';
      if (Array.isArray(s.modules)){
        modulesTemp = s.modules.map(m => ({ id: m.id || uid(), titulo: m.titulo || '', texto: m.texto || '', link: m.link || '', imageFile: null, imageUrl: m.imageUrl || null, file: null }));
        renderModules();
      }
      if (s.cursoNome) toast('Autosave carregado');
    } catch(e) { console.warn('load autosave err', e); }
  }

  // ---------- MODULES: add & render & modal flow ----------
  function openModuleModalFor(index){
    currentModalForIndex = index;
    const m = modulesTemp[index];
    modTitulo.value = m.titulo || '';
    modTexto.value = m.texto || '';
    modLink.value = m.link || '';
    modImageFile.value = '';
    modImageUrl.value = m.imageUrl || '';
    modImagePreview.innerHTML = m.imageUrl ? `<img src="${m.imageUrl}" alt="preview">` : '';
    moduleModal.style.display = 'flex';
    document.getElementById('modalTitle').textContent = `Editar M√≥dulo ${index+1}`;
  }

  function closeModuleModal(){
    moduleModal.style.display = 'none';
    currentModalForIndex = null;
  }

  // create a blank module (and open modal)
  function createBlankModule(){
    const m = { id: uid(), titulo: '', texto: '', link: '', imageFile: null, imageUrl: null, file: null };
    modulesTemp.push(m);
    renderModules();
    openModuleModalFor(modulesTemp.length - 1);
    autosaveLocal();
  }

  // render modules inline
  function renderModules(){
    modulesArea.innerHTML = '';
    modulesTemp.forEach((m, idx) => {
      const el = document.createElement('div');
      el.className = 'module-item';
      el.draggable = true;
      el.dataset.index = idx;
      el.innerHTML = `
        <div class="module-thumb">${m.imageUrl ? `<img src="${m.imageUrl}" alt="thumb">` : '<div style="padding:8px;color:var(--muted)">Sem imagem</div>'}</div>
        <div class="module-body">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="module-title">${escapeHtml(m.titulo || ('M√≥dulo ' + (idx+1)))}</div>
              <div class="muted small">${escapeHtml(truncate(m.texto || '', 140))}</div>
            </div>
            <div style="display:flex;gap:8px">
              <button class="btn small btn-edit" data-index="${idx}">‚úèÔ∏è Editar</button>
            </div>
          </div>
        </div>
      `;
      modulesArea.appendChild(el);
    });

    // attach edit handlers and drag handlers
    modulesArea.querySelectorAll('.btn-edit').forEach(b => {
      b.removeEventListener('click', onEditClick);
      b.addEventListener('click', onEditClick);
    });
    attachDragHandlers();
  }

  function onEditClick(e){
    const idx = Number(e.currentTarget.dataset.index);
    openModuleModalFor(idx);
  }

  // drag and drop reorder (simple)
  function attachDragHandlers(){
    let draggedIndex = null;
    modulesArea.querySelectorAll('.module-item').forEach(item=>{
      item.addEventListener('dragstart', ev => {
        draggedIndex = Number(item.dataset.index);
        ev.dataTransfer.effectAllowed = 'move';
      });
      item.addEventListener('dragover', ev => {
        ev.preventDefault();
        ev.dataTransfer.dropEffect = 'move';
        item.style.transform = 'scale(0.995)';
      });
      item.addEventListener('dragleave', ev => {
        item.style.transform = '';
      });
      item.addEventListener('drop', ev => {
        ev.preventDefault();
        const targetIndex = Number(item.dataset.index);
        if (draggedIndex === null || targetIndex === draggedIndex) return;
        // reorder modulesTemp
        const moved = modulesTemp.splice(draggedIndex, 1)[0];
        modulesTemp.splice(targetIndex, 0, moved);
        renderModules();
        autosaveLocal();
        toast('Ordem dos m√≥dulos atualizada');
      });
      item.addEventListener('dragend', ev => {
        item.style.transform = '';
        draggedIndex = null;
      });
    });
  }

  // modal save: commit fields to modulesTemp
  modalSave.addEventListener('click', async ()=>{
    if (currentModalForIndex === null) return;
    const idx = currentModalForIndex;
    const m = modulesTemp[idx];
    m.titulo = safeText(modTitulo.value);
    m.texto = safeText(modTexto.value);
    m.link = safeText(modLink.value);

    // handle image file input (store File reference)
    const imgF = modImageFile.files[0];
    if (imgF) m.imageFile = imgF;

    // handle file input
    const fileF = modFile.files[0];
    if (fileF) m.file = fileF;

    // image url input wins if provided
    if (modImageUrl.value.trim()){
      m.imageUrl = modImageUrl.value.trim();
    } else if (imgF){
      // preview local blob for immediate UI
      m.imageUrl = URL.createObjectURL(imgF);
    }

    renderModules();
    autosaveLocal();
    closeModuleModal();
    toast('M√≥dulo salvo localmente');
  });

  modalCancel.addEventListener('click', ()=> {
    closeModuleModal();
  });

  // preview thumb in sidebar when file or URL changes
  thumbFile.addEventListener('change', ()=>{
    const f = thumbFile.files[0];
    if (!f){ if (!thumbUrl.value) thumbPreview.innerHTML = ''; return; }
    const u = URL.createObjectURL(f);
    thumbPreview.innerHTML = `<img src="${u}" alt="thumb preview">`;
  });
  thumbUrl.addEventListener('input', ()=>{
    const v = thumbUrl.value.trim();
    if (!v){ if (!thumbFile.files.length) thumbPreview.innerHTML = ''; return; }
    thumbPreview.innerHTML = `<img src="${v}" alt="thumb preview">`;
  });

  // module image preview
  modImageFile.addEventListener('change', ()=>{
    const f = modImageFile.files[0];
    if (!f){ if (!modImageUrl.value) modImagePreview.innerHTML=''; return; }
    modImagePreview.innerHTML = `<img src="${URL.createObjectURL(f)}" alt="module preview">`;
  });
  modImageUrl.addEventListener('input', ()=>{
    const v = modImageUrl.value.trim();
    if (!v){ if (!modImageFile.files.length) modImagePreview.innerHTML=''; return; }
    modImagePreview.innerHTML = `<img src="${v}" alt="module preview">`;
  });

  // ---------- PUBLISH FLOW (course + modules) ----------
  btnPublish.addEventListener('click', async ()=>{
    if (isPublishing) return toast('J√° enviando... aguarde');
    const nome = safeText(cursoNome.value);
    const descricao = safeText(cursoDescricao.value);
    if (!nome || !descricao) { alert('Preencha nome e descri√ß√£o do curso.'); return; }

    isPublishing = true;
    btnPublish.disabled = true;
    publishStatus.textContent = 'Preparando...';

    try {
      // handle thumbnail: prefer file then url
      let thumbnailUrl = thumbUrl.value.trim() || null;
      if (thumbFile.files.length > 0){
        const f = thumbFile.files[0];
        if (!f.type.startsWith('image/')) throw new Error('Thumbnail precisa ser imagem');
        publishStatus.textContent = 'Redimensionando thumbnail...';
        const resizedThumb = await resizeImageFile(f, 1280, 720, 0.85);
        document.getElementById('thumbProgress').style.width = '0%';
        publishStatus.textContent = 'Enviando thumbnail...';
        thumbnailUrl = await uploadWithProgress(`thumbnails/${Date.now()}_${f.name.replace(/\s/g,'_')}`, resizedThumb, pct => {
          document.getElementById('thumbProgress').style.width = pct + '%';
        });
      }

      // prepare course payload
      const tags = (safeText(cursoTags.value) || '').split(',').map(s => s.trim()).filter(Boolean);
      const payload = {
        nome,
        descricao,
        tags,
        nivel: cursoNivel.value || 'Iniciante',
        link: safeText(cursoLink.value) || null,
        thumbnailUrl: thumbnailUrl || null,
        createdAt: Date.now(),
        author: 'an√¥nimo'
      };

      publishStatus.textContent = 'Gravando curso...';
      const courseRef = db.ref('cursos').push();
      await courseRef.set(payload);
      const courseId = courseRef.key;

      // For each module, upload image/file if present, then push to DB
      for (let i = 0; i < modulesTemp.length; i++){
        const m = modulesTemp[i];
        const modulePayload = {
          titulo: m.titulo || `M√≥dulo ${i+1}`,
          texto: m.texto || '',
          link: m.link || null,
          imageUrl: m.imageUrl || null,
          fileUrl: null,
          createdAt: Date.now()
        };

        // image file upload (if provided). If imageFile present, it overrides imageUrl
        if (m.imageFile){
          publishStatus.textContent = `Enviando imagem do m√≥dulo ${i+1}...`;
          moduleProgressBar.style.width = '0%';
          const resized = await resizeImageFile(m.imageFile, 1280, 720, 0.82);
          const path = `modulos-imagens/${courseId}/${Date.now()}_${m.imageFile.name.replace(/\s/g,'_')}`;
          const url = await uploadWithProgress(path, resized, pct => { moduleProgressBar.style.width = pct + '%'; });
          modulePayload.imageUrl = url;
          moduleProgressBar.style.width = '0%';
        }

        // file upload
        if (m.file){
          publishStatus.textContent = `Enviando arquivo do m√≥dulo ${i+1}...`;
          moduleProgressBar.style.width = '0%';
          const path2 = `modulos-files/${courseId}/${Date.now()}_${m.file.name.replace(/\s/g,'_')}`;
          const url2 = await uploadWithProgress(path2, m.file, pct => { moduleProgressBar.style.width = pct + '%'; });
          modulePayload.fileUrl = url2;
          moduleProgressBar.style.width = '0%';
        }

        await db.ref(`cursos/${courseId}/modulos`).push(modulePayload);
      }

      // success
      toast('Curso e m√≥dulos publicados com sucesso!');
      publishStatus.textContent = 'Publicado';
      // clear form & local autosave
      clearAll();
      // refresh preview list
      loadPublishedPreview();

    } catch (e) {
      console.error('publish err', e);
      alert('Erro ao publicar: ' + (e && e.message ? e.message : e));
      // push to uploadQueue for retry
      uploadQueue.push({ modules: modulesTemp.slice(), curso: { nome: cursoNome.value, descricao: cursoDescricao.value } });
      publishStatus.textContent = 'Erro ‚Äî adicionada √† fila';
    } finally {
      isPublishing = false;
      btnPublish.disabled = false;
      // reset progress bars after small delay
      setTimeout(()=> { document.getElementById('thumbProgress').style.width = '0%'; moduleProgressBar.style.width = '0%'; }, 600);
    }
  });

  // ---------- CLEAR / RESET ----------
  btnClear.addEventListener('click', ()=> {
    if (!confirm('Limpar formul√°rio?')) return;
    clearAll();
    toast('Formul√°rio limpo');
  });

  function clearAll(){
    cursoNome.value = '';
    cursoDescricao.value = '';
    cursoTags.value = '';
    cursoNivel.value = 'Iniciante';
    cursoLink.value = '';
    thumbFile.value = '';
    thumbUrl.value = '';
    thumbPreview.innerHTML = '';
    modulesTemp = [];
    renderModules();
    localStorage.removeItem('apm_autosave');
  }

  // ---------- PUBLISHED PREVIEW (visual only) ----------
  async function loadPublishedPreview(){
    publishedList.innerHTML = '';
    noPublished.style.display = 'none';
    try {
      const snap = await db.ref('cursos').orderByChild('createdAt').limitToLast(30).once('value');
      const arr = [];
      snap.forEach(child => {
        const c = child.val(); c._id = child.key;
        arr.push(c);
      });
      arr.sort((a,b) => (b.createdAt || 0) - (a.createdAt || 0));
      publishedCache = arr;
      if (!arr.length) return noPublished.style.display = 'block';
      arr.forEach(c => {
        const card = document.createElement('div');
        card.className = 'course-card';
        card.innerHTML = `
          <div class="thumb">${c.thumbnailUrl ? `<img src="${c.thumbnailUrl}" alt="${escapeHtml(c.nome)}">` : '<div style="padding:14px;color:var(--muted)">Sem imagem</div>'}</div>
          <div style="font-weight:800">${escapeHtml(c.nome)}</div>
          <div class="muted small">${escapeHtml(truncate(c.descricao,160))}</div>
          <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
            <div class="muted small">${c.nivel || ''}</div>
            <div style="margin-left:auto;color:var(--muted);font-size:13px">${new Date(c.createdAt||0).toLocaleString()}</div>
          </div>
        `;
        publishedList.appendChild(card);
      });
    } catch(e){
      console.warn('load preview err', e);
      noPublished.style.display = 'block';
    }
  }

  // ---------- RETRY QUEUE PROCESSOR (basic) ----------
  async function processUploadQueue(){
    if (!uploadQueue.length) return;
    // Attempt to re-publish queued items (very basic logic)
    const item = uploadQueue.shift();
    try {
      toast('Reenviando item da fila...');
      // naive reattempt: push course title only as backup (not restoring all data)
      const ref = db.ref('cursos').push();
      await ref.set({ nome: item.curso.nome || 'Curso (fila)', descricao: item.curso.descricao || '', createdAt: Date.now(), author: 'fila' });
      toast('Item da fila publicado (backup)');
    } catch(e){
      console.warn('retry err', e);
      uploadQueue.push(item); // requeue
    }
  }
  // keep trying retry queue every 30s
  setInterval(processUploadQueue, 30000);

  // ---------- HELPERS ----------
  function truncate(s, n=140){ if(!s) return ''; return s.length > n ? s.slice(0,n-1) + '‚Ä¶' : s; }

  // autosave every 5s while user types (debounced)
  const autoSaveDebounced = debounce(autosaveLocal, 800);
  [cursoNome, cursoDescricao, cursoTags, cursoLink].forEach(el => el.addEventListener('input', autoSaveDebounced));

  // show local autosave on load
  window.addEventListener('load', ()=> {
    loadAutosave();
    loadPublishedPreview();
  });

  // Add module button
  btnAddModule.addEventListener('click', ()=> {
    createBlankModule();
  });

  // Refresh preview
  btnRefresh.addEventListener('click', ()=> {
    loadPublishedPreview();
    toast('Atualizando lista');
  });

  // My courses filter (simple client filter by "author" placeholder)
  btnMyCourses.addEventListener('click', ()=> {
    // we don't have real auth when libre publishing; this button will just filter by "an√¥nimo"
    const mine = publishedCache.filter(c => (c.author||'').includes('an√¥nimo'));
    if (!mine.length) return toast('Nenhum curso criado como an√¥nimo encontrado');
    publishedList.innerHTML = '';
    mine.forEach(c => {
      const card = document.createElement('div'); card.className='course-card';
      card.innerHTML = `<div class="thumb">${c.thumbnailUrl ? `<img src="${c.thumbnailUrl}">` : '<div style="padding:14px;color:var(--muted)">Sem imagem</div>'}</div><div style="font-weight:800">${escapeHtml(c.nome)}</div><div class="muted small">${escapeHtml(truncate(c.descricao,160))}</div>`;
      publishedList.appendChild(card);
    });
    toast('Filtrado: Meus cursos (an√¥nimos)');
  });

  // small UX: pressing Ctrl+S saves the course (publish)
  window.addEventListener('keydown', e => {
    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') {
      e.preventDefault();
      btnPublish.click();
    }
  });

  // ---------- EXTRAS: expose debug
  window._apm = {
    modulesTemp, uploadQueue, loadPublishedPreview, autosaveLocal, clearAll
  };

  </script>
</body>
</html>
